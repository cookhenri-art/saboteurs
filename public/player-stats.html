<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Stats & Badges â€” Saboteur</title>
  <link rel="stylesheet" href="/styles.css" />
  <style>
    :root {
      --neon-main: #00ffff;
      --neon-glow: rgba(0, 255, 255, 0.4);
      --bg-card: rgba(0, 0, 0, 0.35);
      --border-soft: rgba(255, 255, 255, 0.12);
      --text-main: #fff;
      --text-muted: rgba(255, 255, 255, 0.7);
    }

    /* ThÃ¨mes adaptatifs */
    body.theme-werewolf {
      --neon-main: #ff6b35;
      --neon-glow: rgba(255, 107, 53, 0.4);
    }
    body.theme-wizard-academy {
      --neon-main: #a855f7;
      --neon-glow: rgba(168, 85, 247, 0.4);
    }
    body.theme-mythic-realms {
      --neon-main: #fbbf24;
      --neon-glow: rgba(251, 191, 36, 0.4);
    }

    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #0a0a1a 0%, #1a1a2e 50%, #0f0f23 100%);
      color: var(--text-main);
      font-family: 'Segoe UI', system-ui, sans-serif;
    }

    /* Shell principal */
    .stats-shell {
      max-width: 1100px;
      margin: 0 auto;
      padding: 20px 16px 80px;
      position: relative;
      z-index: 1;
    }

    /* Header */
    .stats-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .stats-header h1 {
      font-family: 'Orbitron', 'Segoe UI', sans-serif;
      letter-spacing: 2px;
      font-size: 1.4rem;
      color: var(--neon-main);
      text-shadow: 0 0 20px var(--neon-glow);
      margin: 0;
    }

    .stats-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn-stats {
      padding: 10px 18px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: var(--bg-card);
      color: var(--text-main);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-stats:hover {
      border-color: var(--neon-main);
      box-shadow: 0 0 15px var(--neon-glow);
      transform: translateY(-1px);
    }

    .btn-stats.primary {
      background: linear-gradient(135deg, var(--neon-main), rgba(0, 150, 150, 0.8));
      color: #000;
      border-color: var(--neon-main);
    }

    /* Onglets */
    .stats-tabs {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border-soft);
    }

    .stats-tab {
      padding: 12px 20px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: var(--bg-card);
      cursor: pointer;
      font-weight: 700;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      transition: all 0.15s ease;
    }

    .stats-tab.active {
      border-color: var(--neon-main);
      background: rgba(0, 255, 255, 0.12);
      color: var(--neon-main);
      box-shadow: 0 0 20px var(--neon-glow);
    }

    .stats-tab:hover:not(.active) {
      border-color: rgba(255, 255, 255, 0.3);
      color: var(--text-main);
    }

    /* Profile Hero */
    .profile-hero {
      display: flex;
      gap: 20px;
      align-items: center;
      padding: 24px;
      background: var(--bg-card);
      border: 1px solid var(--border-soft);
      border-radius: 20px;
      margin-bottom: 24px;
    }

    .profile-avatar {
      width: 90px;
      height: 90px;
      border-radius: 50%;
      border: 3px solid var(--neon-main);
      box-shadow: 0 0 25px var(--neon-glow);
      object-fit: cover;
      background: rgba(0, 0, 0, 0.4);
    }

    .profile-avatar.emoji {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 42px;
      background: linear-gradient(135deg, rgba(0,0,0,0.5), rgba(30,30,50,0.5));
    }

    .profile-info {
      flex: 1;
    }

    .profile-name {
      font-size: 1.4rem;
      font-weight: 800;
      letter-spacing: 1px;
      margin-bottom: 4px;
    }

    .profile-status {
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .profile-main-badge {
      text-align: center;
    }

    .main-badge-img {
      width: 80px;
      height: auto;
      filter: drop-shadow(0 0 15px var(--neon-glow));
    }

    .main-badge-rank {
      font-weight: 900;
      font-size: 1.1rem;
      margin-top: 6px;
      color: var(--neon-main);
    }

    /* V42: Quick Stats */
    .quick-stats {
      display: flex;
      justify-content: space-around;
      gap: 12px;
      padding: 16px;
      margin-bottom: 20px;
      background: var(--bg-card);
      border: 1px solid var(--border-soft);
      border-radius: 12px;
    }
    
    .quick-stat {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }
    
    .quick-stat-value {
      font-size: 1.5rem;
      font-weight: 900;
      color: var(--neon-main);
    }
    
    .quick-stat-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    @media (max-width: 500px) {
      .quick-stats {
        flex-wrap: wrap;
        gap: 12px;
        justify-content: center;
      }
      .quick-stat {
        flex: 1 1 30%;
        min-width: 80px;
        max-width: 100px;
      }
      .quick-stat-value {
        font-size: 1.2rem;
      }
      .quick-stat-label {
        font-size: 0.65rem;
      }
    }

    /* Badge Counters */
    .badge-counters {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 24px;
    }

    .badge-counter {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: var(--bg-card);
      border: 1px solid var(--border-soft);
      border-radius: 999px;
    }

    .badge-counter img {
      width: 28px;
      height: 28px;
      object-fit: contain;
    }

    .badge-counter .count {
      font-weight: 900;
      font-size: 1.1rem;
    }

    .badge-counter .label {
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    /* Power Grid */
    .power-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .power-card {
      background: linear-gradient(180deg, rgba(0,0,0,0.35), rgba(0,0,0,0.2));
      border: 1px solid var(--border-soft);
      border-radius: 16px;
      padding: 18px;
      position: relative;
      overflow: hidden;
      transition: all 0.2s ease;
    }

    .power-card:hover {
      border-color: var(--neon-main);
      box-shadow: 0 0 20px var(--neon-glow);
      transform: translateY(-2px);
    }

    .power-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 12px;
    }

    .power-icon {
      font-size: 1.8rem;
    }

    .power-title {
      font-weight: 800;
      font-size: 1rem;
      letter-spacing: 0.5px;
    }

    .power-desc {
      color: var(--text-muted);
      font-size: 0.82rem;
      margin-top: 4px;
    }

    .power-badge {
      min-width: 100px;
      text-align: right;
    }

    /* Progress Circle */
    .progress-circle {
      position: relative;
      width: 70px;
      height: 70px;
      margin-left: auto;
    }

    .progress-circle svg {
      transform: rotate(-90deg);
    }

    .progress-circle .bg {
      fill: none;
      stroke: rgba(255, 255, 255, 0.1);
      stroke-width: 6;
    }

    .progress-circle .fg {
      fill: none;
      stroke: var(--neon-main);
      stroke-width: 6;
      stroke-linecap: round;
      transition: stroke-dashoffset 0.8s ease;
      filter: drop-shadow(0 0 6px var(--neon-glow));
    }

    .progress-circle .value {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      font-size: 0.95rem;
    }

    .power-rank {
      text-align: right;
      margin-top: 8px;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .power-rank strong {
      color: var(--neon-main);
    }

    .power-volume {
      font-size: 0.7rem;
      color: var(--text-muted);
      opacity: 0.7;
      margin-top: 2px;
    }

    /* Badge Tiers */
    .tier-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      font-weight: 800;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      position: relative;
      overflow: hidden;
    }

    .tier-badge img {
      width: 20px;
      height: 20px;
    }

    .tier-bronze {
      background: linear-gradient(135deg, rgba(205,127,50,0.35), rgba(0,0,0,0.2));
      border: 1px solid rgba(205,127,50,0.6);
      color: #cd7f32;
    }

    .tier-iron {
      background: linear-gradient(135deg, rgba(128,128,128,0.35), rgba(0,0,0,0.2));
      border: 1px solid rgba(128,128,128,0.6);
      color: #9ca3af;
    }

    .tier-silver {
      background: linear-gradient(135deg, rgba(192,192,192,0.35), rgba(0,0,0,0.2));
      border: 1px solid rgba(192,192,192,0.6);
      color: #c0c0c0;
    }

    .tier-gold {
      background: linear-gradient(135deg, rgba(255,215,0,0.35), rgba(0,0,0,0.2));
      border: 1px solid rgba(255,215,0,0.7);
      color: #ffd700;
    }

    .tier-platinum {
      background: linear-gradient(135deg, rgba(160,240,255,0.35), rgba(0,0,0,0.2));
      border: 1px solid rgba(160,240,255,0.7);
      color: #a0f0ff;
    }

    .tier-locked {
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.15);
      color: var(--text-muted);
    }

    /* Shimmer animation for gold/platinum */
    @keyframes shimmer {
      0% { transform: translateX(-120%); }
      100% { transform: translateX(120%); }
    }

    .tier-gold::after, .tier-platinum::after {
      content: '';
      position: absolute;
      top: -50%;
      left: -60%;
      width: 50%;
      height: 200%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.5), transparent);
      transform: translateX(-120%);
      animation: shimmer 2.5s linear infinite;
    }

    .tier-platinum::after {
      animation-duration: 2s;
    }

    /* Leaderboard */
    .lb-table {
      width: 100%;
      border-collapse: collapse;
      background: var(--bg-card);
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid var(--border-soft);
    }

    .lb-table th, .lb-table td {
      padding: 14px 16px;
      text-align: left;
      border-bottom: 1px solid var(--border-soft);
    }

    .lb-table th {
      background: rgba(0, 0, 0, 0.3);
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-muted);
    }

    .lb-table tr.me {
      background: rgba(0, 255, 255, 0.1);
    }

    .lb-table tr:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    /* Leaderboard Grid */
    .lb-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
    }

    .lb-card {
      background: var(--bg-card);
      border: 1px solid var(--border-soft);
      border-radius: 16px;
      padding: 18px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .lb-card:hover {
      border-color: var(--neon-main);
      box-shadow: 0 0 20px var(--neon-glow);
    }

    .lb-card-title {
      font-weight: 800;
      margin-bottom: 8px;
    }

    .lb-card-desc {
      color: var(--text-muted);
      font-size: 0.85rem;
      margin-bottom: 12px;
    }

    .lb-card-count {
      font-size: 0.9rem;
      color: var(--neon-main);
    }

    .lb-card-top {
      margin: 10px 0;
      font-size: 0.82rem;
    }

    .lb-card-top-row {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .lb-card-top-row:last-child {
      border-bottom: none;
    }

    .lb-card-top-rank {
      width: 20px;
      font-weight: 800;
      color: var(--text-muted);
    }

    .lb-card-top-row:nth-child(1) .lb-card-top-rank { color: #ffd700; }
    .lb-card-top-row:nth-child(2) .lb-card-top-rank { color: #c0c0c0; }
    .lb-card-top-row:nth-child(3) .lb-card-top-rank { color: #cd7f32; }

    .lb-card-top-name {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .lb-card-top-name.is-me {
      color: var(--neon-main);
      font-weight: 700;
    }

    .lb-card-top-score {
      color: var(--text-muted);
      font-size: 0.78rem;
    }

    /* Views */
    .view { display: none; }
    .view.active { display: block; }

    /* Loading */
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--text-muted);
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(4px);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: linear-gradient(180deg, #1a1a2e, #0f0f23);
      border: 1px solid var(--border-soft);
      border-radius: 20px;
      max-width: 600px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      padding: 24px;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-weight: 800;
      font-size: 1.2rem;
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 4px;
    }

    .modal-close:hover {
      color: var(--text-main);
    }

    /* Responsive */
    @media (max-width: 600px) {
      .profile-hero {
        flex-direction: column;
        text-align: center;
      }
      
      .profile-main-badge {
        margin-top: 16px;
      }

      .power-grid {
        grid-template-columns: 1fr;
      }

      .badge-counters {
        justify-content: center;
      }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       V11: ONGLET DÃ‰TAILLÃ‰ - Styles pour camemberts et stats
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    .detailed-section {
      margin-bottom: 32px;
    }
    
    .detailed-section-title {
      font-size: 1.1rem;
      font-weight: 800;
      color: var(--neon-main);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .charts-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 24px;
      margin-bottom: 32px;
    }
    
    .chart-card {
      background: var(--bg-card);
      border: 1px solid var(--border-soft);
      border-radius: 16px;
      padding: 20px;
      text-align: center;
    }
    
    .chart-card h3 {
      font-size: 1rem;
      font-weight: 700;
      color: var(--text-main);
      margin-bottom: 16px;
    }
    
    .chart-container {
      position: relative;
      height: 220px;
      margin-bottom: 12px;
    }
    
    .chart-legend {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px 16px;
      font-size: 0.8rem;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 3px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
    }
    
    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border-soft);
      border-radius: 16px;
      padding: 20px;
    }
    
    .stat-card-title {
      font-size: 1rem;
      font-weight: 800;
      color: var(--neon-main);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .stat-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid var(--border-soft);
    }
    
    .stat-row:last-child {
      border-bottom: none;
    }
    
    .stat-label {
      color: var(--text-muted);
      font-size: 0.9rem;
    }
    
    .stat-value {
      font-weight: 700;
      color: var(--text-main);
    }
    
    .stat-value.good {
      color: #4ade80;
    }
    
    .stat-value.bad {
      color: #f87171;
    }
    
    .stat-bar-container {
      width: 100%;
      height: 8px;
      background: var(--border-soft);
      border-radius: 4px;
      margin-top: 8px;
      overflow: hidden;
    }
    
    .stat-bar {
      height: 100%;
      border-radius: 4px;
      transition: width 0.5s ease;
    }
    
    .stat-bar.good {
      background: linear-gradient(90deg, #4ade80, #22c55e);
    }
    
    .stat-bar.bad {
      background: linear-gradient(90deg, #f87171, #ef4444);
    }
    
    .stat-bar.neutral {
      background: linear-gradient(90deg, var(--neon-main), var(--neon-secondary));
    }
    
    .no-data-message {
      text-align: center;
      color: var(--text-muted);
      padding: 40px;
      font-style: italic;
    }
    
    @media (max-width: 600px) {
      .charts-row {
        grid-template-columns: 1fr;
      }
      .stats-grid {
        grid-template-columns: 1fr;
      }
      .chart-container {
        height: 180px;
      }
    }
  </style>
</head>
<body>
  <div class="stats-shell">
    <!-- Header -->
    <div class="stats-header">
      <h1 data-i18n-site="stats.page_title">ğŸ“Š STATS & BADGES</h1>
      <div class="stats-actions">
        <button id="btnBackToGame" class="btn-stats primary" style="display:none;" onclick="backToGame()" data-i18n-site="stats.back_to_game">
          ğŸ® Retour Ã  la partie
        </button>
        <button class="btn-stats" onclick="showExplanations()" data-i18n-site="stats.explanations">â“ Explications</button>
        <a href="/" class="btn-stats" data-i18n-site="stats.home">ğŸ  Accueil</a>
        <button class="btn-stats" onclick="refreshAll()" data-i18n-site="stats.refresh">ğŸ”„ Actualiser</button>
      </div>
    </div>

    <!-- Tabs -->
    <div class="stats-tabs">
      <button class="stats-tab active" data-view="profile" onclick="switchTab('profile')" data-i18n-site="stats.tab_profile">ğŸ‘¤ Mon Profil</button>
      <button class="stats-tab" data-view="detailed" onclick="switchTab('detailed')" data-i18n-site="stats.tab_detailed">ğŸ“Š DÃ©taillÃ©</button>
      <button class="stats-tab" data-view="leaderboards" onclick="switchTab('leaderboards')" data-i18n-site="stats.tab_leaderboards">ğŸ“ˆ Classements</button>
      <button class="stats-tab" data-view="archives" onclick="switchTab('archives')" data-i18n-site="stats.tab_archives">ğŸ“… Archives</button>
    </div>

    <!-- View: Profile -->
    <div id="viewProfile" class="view active">
      <!-- Profile Hero -->
      <div class="profile-hero">
        <div id="profileAvatarContainer">
          <img id="profileAvatar" class="profile-avatar" src="" alt="Avatar" />
        </div>
        <div class="profile-info">
          <div class="profile-name" id="profileName" data-i18n-site="stats.loading">Chargement...</div>
          <div class="profile-status" id="profileStatus" data-i18n-site="stats.login_to_see_stats">Connecte-toi pour voir tes stats</div>
        </div>
        <div class="profile-main-badge" id="profileMainBadge">
          <img class="main-badge-img" src="/images/badges/fer.png" alt="Badge" id="mainBadgeImg" />
          <div class="main-badge-rank" id="mainBadgeRank">â€”</div>
        </div>
      </div>

      <!-- V42: Quick Stats -->
      <div class="quick-stats" id="quickStats">
        <div class="quick-stat">
          <span class="quick-stat-value" id="statTotalGames">0</span>
          <span class="quick-stat-label" data-i18n-site="stats.total_games">Parties</span>
        </div>
        <div class="quick-stat">
          <span class="quick-stat-value" id="statWins">0</span>
          <span class="quick-stat-label" data-i18n-site="stats.wins">Victoires</span>
        </div>
        <div class="quick-stat">
          <span class="quick-stat-value" id="statWinRate">0%</span>
          <span class="quick-stat-label" data-i18n-site="stats.win_rate">Win Rate</span>
        </div>
        <div class="quick-stat">
          <span class="quick-stat-value" id="statAstronautGames">0</span>
          <span class="quick-stat-label" id="statAstronautLabel" data-i18n-site="stats.astronaut_games">Astronaute</span>
        </div>
        <div class="quick-stat">
          <span class="quick-stat-value" id="statSaboteurGames">0</span>
          <span class="quick-stat-label" id="statSaboteurLabel" data-i18n-site="stats.saboteur_games">Saboteur</span>
        </div>
        <div class="quick-stat">
          <span class="quick-stat-value" id="statTotalTime">0h</span>
          <span class="quick-stat-label" data-i18n-site="stats.total_time">Temps jouÃ©</span>
        </div>
      </div>

      <!-- Badge Counters -->
      <div class="badge-counters" id="badgeCounters">
        <div class="badge-counter">
          <img src="/images/badges/platine.png" alt="Platine" />
          <span class="count" id="countPlatine">0</span>
          <span class="label" data-i18n-site="stats.badge_platinum">Platine</span>
        </div>
        <div class="badge-counter">
          <img src="/images/badges/or.png" alt="Or" />
          <span class="count" id="countOr">0</span>
          <span class="label" data-i18n-site="stats.badge_gold">Or</span>
        </div>
        <div class="badge-counter">
          <img src="/images/badges/argent.png" alt="Argent" />
          <span class="count" id="countArgent">0</span>
          <span class="label" data-i18n-site="stats.badge_silver">Argent</span>
        </div>
        <div class="badge-counter">
          <img src="/images/badges/bronze.png" alt="Bronze" />
          <span class="count" id="countBronze">0</span>
          <span class="label" data-i18n-site="stats.badge_bronze">Bronze</span>
        </div>
        <div class="badge-counter">
          <img src="/images/badges/fer.png" alt="Fer" />
          <span class="count" id="countFer">0</span>
          <span class="label" data-i18n-site="stats.badge_iron">Fer</span>
        </div>
      </div>

      <!-- Power Grid -->
      <div class="power-grid" id="powerGrid">
        <div class="loading" data-i18n-site="stats.loading_powers">Chargement des pouvoirs...</div>
      </div>
    </div>

    <!-- View: Leaderboards -->
    <div id="viewLeaderboards" class="view">
      <div class="lb-grid" id="lbGrid">
        <div class="loading">Chargement des classements...</div>
      </div>
    </div>

    <!-- View: Archives -->
    <div id="viewArchives" class="view">
      <div id="archivesContent">
        <div class="loading">Chargement des archives...</div>
      </div>
    </div>

    <!-- View: Detailed (V11) -->
    <div id="viewDetailed" class="view">
      <div id="detailedContent">
        <div class="loading">Chargement des statistiques dÃ©taillÃ©es...</div>
      </div>
    </div>
  </div>

  <!-- Modal for leaderboard details -->
  <div class="modal-overlay" id="lbModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">Classement</div>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div id="modalBody">
        <div class="loading">Chargement...</div>
      </div>
    </div>
  </div>

  <!-- Modal for explanations -->
  <div class="modal-overlay" id="explanationsModal">
    <div class="modal-content" style="max-width:700px;">
      <div class="modal-header">
        <div class="modal-title" data-i18n-site="stats.how_stats_work">â“ Comment fonctionnent les Stats & Badges</div>
        <button class="modal-close" onclick="closeExplanations()">&times;</button>
      </div>
      <div style="line-height:1.6;color:var(--text-main);">
        
        <h3 style="color:var(--neon-main);margin:0 0 12px;" data-i18n-site="stats.badge_acquisition">ğŸ… Obtention des Badges</h3>
        <table style="width:100%;border-collapse:collapse;margin-bottom:20px;font-size:0.9rem;">
          <tr style="border-bottom:1px solid var(--border-soft);">
            <td style="padding:8px;"><img src="/images/badges/fer.png" style="width:24px;vertical-align:middle;"> <span data-i18n-site="stats.badge_iron">Fer</span></td>
            <td style="padding:8px;color:var(--text-muted);" data-i18n-site="stats.score_0_60">Score de 0% Ã  59%</td>
          </tr>
          <tr style="border-bottom:1px solid var(--border-soft);">
            <td style="padding:8px;"><img src="/images/badges/bronze.png" style="width:24px;vertical-align:middle;"> <span data-i18n-site="stats.badge_bronze">Bronze</span></td>
            <td style="padding:8px;color:var(--text-muted);" data-i18n-site="stats.score_60_70">Score de 60% Ã  69%</td>
          </tr>
          <tr style="border-bottom:1px solid var(--border-soft);">
            <td style="padding:8px;"><img src="/images/badges/argent.png" style="width:24px;vertical-align:middle;"> <span data-i18n-site="stats.badge_silver">Argent</span></td>
            <td style="padding:8px;color:var(--text-muted);" data-i18n-site="stats.score_70_80">Score de 70% Ã  79%</td>
          </tr>
          <tr style="border-bottom:1px solid var(--border-soft);">
            <td style="padding:8px;"><img src="/images/badges/or.png" style="width:24px;vertical-align:middle;"> <span data-i18n-site="stats.badge_gold">Or</span></td>
            <td style="padding:8px;color:var(--text-muted);" data-i18n-site="stats.score_80_90">Score de 80% Ã  89%</td>
          </tr>
          <tr>
            <td style="padding:8px;"><img src="/images/badges/platine.png" style="width:24px;vertical-align:middle;"> <span data-i18n-site="stats.badge_platinum">Platine</span></td>
            <td style="padding:8px;color:var(--text-muted);" data-i18n-site="stats.score_90_100">Score de 90% Ã  100%</td>
          </tr>
        </table>
        
        <h3 style="color:var(--neon-main);margin:20px 0 12px;" data-i18n-site="stats.power_calculation">ğŸ“Š Calcul des Pouvoirs (Score 0-100%)</h3>
        
        <div style="margin-bottom:16px;">
          <strong>ğŸ† <span data-i18n-site="stats.power_champion">Champion</span></strong> â€” <span data-i18n-site="stats.champion_calc">Moyenne pondÃ©rÃ©e des 8 pouvoirs, ajustÃ©e par ton win rate</span>
          <div style="color:var(--text-muted);font-size:0.85rem;margin-top:4px;" data-i18n-site="stats.champion_winrate_info">
            âš ï¸ Score multipliÃ© par ton taux de victoire (Ã—0.7 Ã  Ã—1.0). NÃ©cessite 6 pouvoirs sur 8 enclenchÃ©s.
          </div>
        </div>
        
        <div style="margin-bottom:16px;">
          <strong>ğŸ§ª <span data-i18n-site="stats.power_doctor">Docteur/SorciÃ¨re</span></strong><br>
          <span style="color:var(--text-muted);font-size:0.85rem;" data-i18n-site="stats.doctor_calc_1">60% : Taux de soins rÃ©ussis sur astronautes</span><br>
          <span style="color:var(--text-muted);font-size:0.85rem;" data-i18n-site="stats.doctor_calc_2">40% : Potions mortelles utilisÃ©es sur saboteurs</span>
        </div>
        
        <div style="margin-bottom:16px;">
          <strong>ğŸ­ <span data-i18n-site="stats.power_bluffer">Bluffer (Incognito)</span></strong><br>
          <span style="color:var(--text-muted);font-size:0.85rem;" data-i18n-site="stats.bluffer_calc">Victoires en tant que saboteur sans recevoir aucun vote contre toi</span>
        </div>
        
        <div style="margin-bottom:16px;">
          <strong>ğŸ›¡ï¸ <span data-i18n-site="stats.power_resistant">RÃ©sistant</span></strong><br>
          <span style="color:var(--text-muted);font-size:0.85rem;" data-i18n-site="stats.resistant_calc">Temps passÃ© vivant / Temps total de tes parties</span>
        </div>
        
        <div style="margin-bottom:16px;">
          <strong>ğŸ•µï¸ <span data-i18n-site="stats.power_investigator">EnquÃªteur</span></strong><br>
          <span style="color:var(--text-muted);font-size:0.85rem;" data-i18n-site="stats.investigator_calc">Votes corrects contre saboteurs vs votes erronÃ©s</span>
        </div>
        
        <div style="margin-bottom:16px;">
          <strong>ğŸ‘‘ <span data-i18n-site="stats.power_captain">Chef de station</span></strong><br>
          <span style="color:var(--text-muted);font-size:0.85rem;" data-i18n-site="stats.captain_calc">DÃ©partages du maire tuant un saboteur + Transferts de capitaine vers un astronaute</span>
        </div>
        
        <div style="margin-bottom:16px;">
          <strong>ğŸ”« <span data-i18n-site="stats.power_security">Chef de sÃ©curitÃ©</span></strong><br>
          <span style="color:var(--text-muted);font-size:0.85rem;" data-i18n-site="stats.security_calc">Vengeance efficace : tirs mortels sur saboteurs vs tirs amis</span>
        </div>
        
        <div style="margin-bottom:16px;">
          <strong>ğŸ”¥ <span data-i18n-site="stats.power_streak">SÃ©rie de Victoires</span></strong><br>
          <span style="color:var(--text-muted);font-size:0.85rem;" data-i18n-site="stats.streak_calc">Ta plus longue sÃ©rie de victoires consÃ©cutives</span>
        </div>
        
        <div style="margin-bottom:16px;">
          <strong>â˜ ï¸ <span data-i18n-site="stats.power_exterminator">Exterminateur</span></strong><br>
          <span style="color:var(--text-muted);font-size:0.85rem;" data-i18n-site="stats.exterminator_calc">Potions mortelles utilisÃ©es sur astronautes (rÃ´le saboteur uniquement)</span>
        </div>
        
        <h3 style="color:var(--neon-main);margin:20px 0 12px;" data-i18n-site="stats.ranking_info">ğŸ“ˆ Classement</h3>
        <p style="color:var(--text-muted);font-size:0.9rem;margin:0;" data-i18n-site="stats.ranking_details">
          Seuls les <strong>comptes vÃ©rifiÃ©s</strong> (email confirmÃ©) sont pris en compte dans les classements.<br>
          Le badge principal correspond au classement <strong>Champion</strong> (moyenne globale).<br>
          Le numÃ©ro affichÃ© (#12) est ton rang parmi tous les joueurs Ã©ligibles.
        </p>
        
        <div style="margin-top:15px;padding:12px;background:rgba(0,255,255,0.1);border-radius:8px;border-left:3px solid var(--neon-main);">
          <strong style="color:var(--neon-main);" data-i18n-site="stats.minimum_games_title">âš ï¸ Minimum requis</strong>
          <p style="color:var(--text-muted);font-size:0.9rem;margin:8px 0 0;" data-i18n-site="stats.minimum_games_text">
            Pour apparaÃ®tre dans les classements, tu dois avoir jouÃ© <strong>au moins 10 parties</strong>.<br>
            Cela permet d'avoir des statistiques reprÃ©sentatives de ton niveau rÃ©el.
          </p>
        </div>
        
        <div style="margin-top:15px;padding:12px;background:rgba(255,165,0,0.1);border-radius:8px;border-left:3px solid orange;">
          <strong style="color:orange;" data-i18n-site="stats.coverage_title">ğŸ“Š PondÃ©ration (Coverage)</strong>
          <p style="color:var(--text-muted);font-size:0.9rem;margin:8px 0 0;" data-i18n-site="stats.coverage_text">
            Ton score est pondÃ©rÃ© par le nombre d'actions rÃ©alisÃ©es (max 10).<br>
            <strong>Exemple :</strong> 100% de prÃ©cision avec 2 actions = 20% final. Avec 10+ actions = 100%.
          </p>
        </div>
        
      </div>
    </div>
  </div>

  <!-- Chart.js pour les camemberts (V11) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CONFIGURATION & STATE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    let meData = null;
    let postgameData = null;
    
    const POWER_ICONS = {
      A: "ğŸ§ª", B: "ğŸ­", C: "ğŸ›¡ï¸", D: "â˜ ï¸", 
      E: "ğŸ•µï¸", F: "ğŸ‘‘", G: "ğŸ”«", I: "ğŸ”¥", H: "ğŸ†"
    };
    
    const POWER_LABELS = {
      A: ["Docteur / SorciÃ¨re", "Soins astro + potions mort saboteurs"],
      B: ["Bluffer (Incognito)", "Victoire saboteur + 0 vote contre toi"],
      C: ["Le plus RÃ©sistant", "Taux de survie en fin de partie"],
      D: ["Exterminateur", "Potions mort sur astronautes"],
      E: ["EnquÃªteur", "Votes justes vs saboteurs"],
      F: ["Chef de station", "DÃ©partages + transferts pro-astro"],
      G: ["Chef de sÃ©curitÃ©", "Vengeance efficace vs saboteur"],
      I: ["SÃ©rie de Victoires", "Meilleure streak (tous rÃ´les)"],
      H: ["Champion", "Moyenne Ã— Win Rate (6/8 pouvoirs)"]
    };

    const TIER_LABELS = {
      platinum: "Platine", gold: "Or", silver: "Argent", bronze: "Bronze", iron: "Fer"
    };
    
    const TIER_FILES = {
      platinum: "platine", gold: "or", silver: "argent", bronze: "bronze", iron: "fer"
    };
    
    // Fonction pour rÃ©cupÃ©rer la langue courante (compatible avec toutes les clÃ©s)
    function getCurrentLang() {
      // PrioritÃ© : saboteur_language > saboteur_lang > site_language > navigateur > fr
      return localStorage.getItem('saboteur_language') 
          || localStorage.getItem('saboteur_lang') 
          || localStorage.getItem('site_language') 
          || navigator.language.split('-')[0] 
          || 'fr';
    }
    
    // Fonction pour rÃ©cupÃ©rer les traductions dynamiques
    function t(key, fallback) {
      if (typeof SITE_TRANSLATIONS !== 'undefined' && SITE_TRANSLATIONS.stats) {
        const lang = getCurrentLang();
        const val = SITE_TRANSLATIONS.stats[key];
        if (val && val[lang]) return val[lang];
        if (val && val['fr']) return val['fr'];
      }
      return fallback;
    }
    
    // Labels traduits dynamiquement
    function getPowerLabels() {
      return {
        A: [t('power_doctor', 'Docteur / SorciÃ¨re'), t('power_doctor_desc', 'Soins astro + potions mort saboteurs')],
        B: [t('power_bluffer', 'Bluffer (Incognito)'), t('power_bluffer_desc', 'Victoire saboteur + 0 vote contre toi')],
        C: [t('power_resistant', 'Le plus RÃ©sistant'), t('power_resistant_desc', 'Taux de survie en fin de partie')],
        D: [t('power_exterminator', 'Exterminateur'), t('power_exterminator_desc', 'Potions mort sur astronautes')],
        E: [t('power_investigator', 'EnquÃªteur'), t('power_investigator_desc', 'Votes justes vs saboteurs')],
        F: [t('power_captain', 'Chef de station'), t('power_captain_desc', 'DÃ©partages + transferts pro-astro')],
        G: [t('power_security', 'Chef de sÃ©curitÃ©'), t('power_security_desc', 'Vengeance efficace vs saboteur')],
        I: [t('power_streak', 'SÃ©rie de Victoires'), t('power_streak_desc', 'Meilleure streak (tous rÃ´les)')],
        H: [t('power_champion', 'Champion'), t('power_champion_desc', 'Moyenne pondÃ©rÃ©e globale')]
      };
    }
    
    function getTierLabels() {
      return {
        platinum: t('badge_platinum', 'Platine'),
        gold: t('badge_gold', 'Or'),
        silver: t('badge_silver', 'Argent'),
        bronze: t('badge_bronze', 'Bronze'),
        iron: t('badge_iron', 'Fer')
      };
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // UTILITIES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function getUrlParams() {
      const params = {};
      new URLSearchParams(window.location.search).forEach((v, k) => params[k] = v);
      return params;
    }

    function getToken() {
      return localStorage.getItem('saboteur_token');
    }

    function getLocalUser() {
      try {
        return JSON.parse(localStorage.getItem('saboteur_user') || 'null');
      } catch { return null; }
    }

    function applyTheme() {
      const theme = localStorage.getItem('saboteur_theme') || 'default';
      document.body.className = '';
      if (theme && theme !== 'default') {
        document.body.classList.add(`theme-${theme}`);
      }
    }
    
    // V42: Noms des Ã©quipes selon le thÃ¨me
    function getTeamNames() {
      const theme = localStorage.getItem('saboteur_theme') || 'default';
      const lang = getCurrentLang();
      
      const names = {
        'default': {
          fr: { astronaut: 'Astronaute', saboteur: 'Saboteur' },
          en: { astronaut: 'Astronaut', saboteur: 'Saboteur' },
          es: { astronaut: 'Astronauta', saboteur: 'Saboteador' },
          de: { astronaut: 'Astronaut', saboteur: 'Saboteur' },
          it: { astronaut: 'Astronauta', saboteur: 'Sabotatore' },
          pt: { astronaut: 'Astronauta', saboteur: 'Sabotador' },
          nl: { astronaut: 'Astronaut', saboteur: 'Saboteur' }
        },
        'werewolf': {
          fr: { astronaut: 'Villageois', saboteur: 'Loup-Garou' },
          en: { astronaut: 'Villager', saboteur: 'Werewolf' },
          es: { astronaut: 'Aldeano', saboteur: 'Hombre Lobo' },
          de: { astronaut: 'Dorfbewohner', saboteur: 'Werwolf' },
          it: { astronaut: 'Villico', saboteur: 'Lupo Mannaro' },
          pt: { astronaut: 'AldeÃ£o', saboteur: 'Lobisomem' },
          nl: { astronaut: 'Dorpeling', saboteur: 'Weerwolf' }
        },
        'wizard-academy': {
          fr: { astronaut: 'Ã‰lÃ¨ve', saboteur: 'Sorcier Noir' },
          en: { astronaut: 'Student', saboteur: 'Dark Wizard' },
          es: { astronaut: 'Estudiante', saboteur: 'Mago Oscuro' },
          de: { astronaut: 'SchÃ¼ler', saboteur: 'Schwarzmagier' },
          it: { astronaut: 'Studente', saboteur: 'Mago Oscuro' },
          pt: { astronaut: 'Estudante', saboteur: 'Mago Negro' },
          nl: { astronaut: 'Student', saboteur: 'Duistere Tovenaar' }
        },
        'mythic-realms': {
          fr: { astronaut: 'HÃ©ros', saboteur: 'Titan' },
          en: { astronaut: 'Hero', saboteur: 'Titan' },
          es: { astronaut: 'HÃ©roe', saboteur: 'TitÃ¡n' },
          de: { astronaut: 'Held', saboteur: 'Titan' },
          it: { astronaut: 'Eroe', saboteur: 'Titano' },
          pt: { astronaut: 'HerÃ³i', saboteur: 'TitÃ£' },
          nl: { astronaut: 'Held', saboteur: 'Titan' }
        }
      };
      
      const themeNames = names[theme] || names['default'];
      return themeNames[lang] || themeNames['fr'];
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // RENDERING
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function renderProgressCircle(percent, size = 70) {
      const r = (size - 12) / 2;
      const c = 2 * Math.PI * r;
      const offset = c - (percent / 100) * c;
      return `
        <div class="progress-circle" style="width:${size}px;height:${size}px;">
          <svg width="${size}" height="${size}">
            <circle class="bg" cx="${size/2}" cy="${size/2}" r="${r}" />
            <circle class="fg" cx="${size/2}" cy="${size/2}" r="${r}" 
                    stroke-dasharray="${c}" stroke-dashoffset="${offset}" />
          </svg>
          <div class="value">${Math.round(percent)}%</div>
        </div>
      `;
    }

    // V42: Afficher le nombre de victoires en sÃ©rie (pas un %)
    function renderStreakNumber(streak, size = 70) {
      return `
        <div class="progress-circle streak-display" style="width:${size}px;height:${size}px;">
          <svg width="${size}" height="${size}">
            <circle class="bg" cx="${size/2}" cy="${size/2}" r="${(size - 12) / 2}" />
            <circle class="fg" cx="${size/2}" cy="${size/2}" r="${(size - 12) / 2}" 
                    stroke-dasharray="${2 * Math.PI * ((size - 12) / 2)}" stroke-dashoffset="0" style="stroke: #ff6b35;" />
          </svg>
          <div class="value" style="font-size: 1.3em;">Ã—${streak}</div>
        </div>
      `;
    }

    // V42: Calculer le tier depuis le score brut (sans coverage)
    function getTierFromScore(score) {
      if (score >= 90) return 'platinum';
      if (score >= 80) return 'gold';
      if (score >= 70) return 'silver';
      if (score >= 60) return 'bronze';
      return 'iron';
    }

    function renderTierBadge(tier, rank) {
      if (!tier) {
        return `<span class="tier-badge tier-locked">${t('unranked', 'ğŸ”’ Non classÃ©')}</span>`;
      }
      const tierLabels = getTierLabels();
      const label = tierLabels[tier] || tier;
      const file = TIER_FILES[tier] || 'fer';
      const img = `/images/badges/${file}.png`;
      return `
        <span class="tier-badge tier-${tier}">
          <img src="${img}" alt="${label}" />
          ${label} ${rank ? '#' + rank : ''}
        </span>
      `;
    }

    function renderProfile() {
      const localUser = getLocalUser();
      const avatarEl = document.getElementById('profileAvatar');
      const nameEl = document.getElementById('profileName');
      const statusEl = document.getElementById('profileStatus');
      const mainBadgeImg = document.getElementById('mainBadgeImg');
      const mainBadgeRank = document.getElementById('mainBadgeRank');
      const powerGrid = document.getElementById('powerGrid');

      // V42: Afficher les quick-stats
      const stats = meData?.stats || {};
      const gamesByRole = stats.gamesByRole || {};
      
      // Parties totales
      const totalGames = Number(stats.gamesPlayed || 0);
      document.getElementById('statTotalGames').textContent = totalGames;
      
      // Victoires et Win Rate
      const wins = Number(stats.wins || 0);
      const winRate = totalGames > 0 ? Math.round((wins / totalGames) * 100) : 0;
      document.getElementById('statWins').textContent = wins;
      document.getElementById('statWinRate').textContent = `${winRate}%`;
      
      // Parties saboteur (tous les rÃ´les saboteur selon thÃ¨me)
      const saboteurRoles = ['saboteur', 'loup_garou', 'loup_alpha', 'imposteur', 'sorcier_noir', 'apprenti_sorcier', 'necromancien', 'titan', 'meduse', 'hydre'];
      let saboteurGames = 0;
      for (const role of saboteurRoles) {
        saboteurGames += Number(gamesByRole[role] || 0);
      }
      document.getElementById('statSaboteurGames').textContent = saboteurGames;
      
      // Parties astronaute = total - saboteur (plus simple et plus fiable)
      const astronautGames = totalGames - saboteurGames;
      document.getElementById('statAstronautGames').textContent = astronautGames;
      
      // V42: Mettre Ã  jour les labels selon le thÃ¨me
      const teamNames = getTeamNames();
      document.getElementById('statAstronautLabel').textContent = teamNames.astronaut;
      document.getElementById('statSaboteurLabel').textContent = teamNames.saboteur;
      
      // Temps total formatÃ©
      const totalMs = Number(stats.gameTimeMsTotal || 0);
      const totalHours = Math.floor(totalMs / (1000 * 60 * 60));
      const totalMins = Math.floor((totalMs % (1000 * 60 * 60)) / (1000 * 60));
      if (totalHours > 0) {
        document.getElementById('statTotalTime').textContent = `${totalHours}h${totalMins > 0 ? totalMins : ''}`;
      } else if (totalMins > 0) {
        document.getElementById('statTotalTime').textContent = `${totalMins}min`;
      } else {
        document.getElementById('statTotalTime').textContent = '0';
      }

      // Avatar et nom
      if (meData && meData.user) {
        nameEl.textContent = meData.user.username;
        statusEl.textContent = meData.user.emailVerified ? t('verified_account', 'âœ… Compte vÃ©rifiÃ©') : t('unverified_email', 'âš ï¸ Email non vÃ©rifiÃ©');
        
        const avatar = meData.user.currentAvatar || localUser?.currentAvatar;
        if (avatar) {
          if (avatar.length <= 4) {
            // Emoji
            avatarEl.style.display = 'none';
            const container = document.getElementById('profileAvatarContainer');
            container.innerHTML = `<div class="profile-avatar emoji">${avatar}</div>`;
          } else {
            avatarEl.src = avatar;
            avatarEl.style.display = '';
          }
        } else {
          avatarEl.src = '';
          const container = document.getElementById('profileAvatarContainer');
          container.innerHTML = `<div class="profile-avatar emoji">ğŸ‘¤</div>`;
        }
      } else if (localUser) {
        nameEl.textContent = localUser.username || 'Joueur';
        statusEl.textContent = t('persistent_stats_info', 'Connecte-toi pour des stats persistantes');
        const container = document.getElementById('profileAvatarContainer');
        container.innerHTML = `<div class="profile-avatar emoji">${localUser.currentAvatar || 'ğŸ‘¤'}</div>`;
      } else {
        nameEl.textContent = t('not_logged_in', 'Non connectÃ©');
        statusEl.textContent = t('login_to_see_stats', 'Connecte-toi pour voir tes stats');
      }

      // Pouvoirs
      const powers = meData?.powers || {};
      const order = ["H", "A", "B", "C", "E", "F", "G", "I", "D"];
      
      // Compter les badges - V42: basÃ© sur scoreRaw (sans coverage)
      const counts = { platinum: 0, gold: 0, silver: 0, bronze: 0, iron: 0 };
      for (const k of order) {
        const p = powers[k];
        if (p) {
          // Champion utilise le tier du serveur, les autres le tier depuis scoreRaw
          const tier = (k === 'H') ? p.tier : getTierFromScore(p.scoreRaw || 0);
          if (tier && counts[tier] !== undefined) {
            counts[tier]++;
          }
        }
      }
      document.getElementById('countPlatine').textContent = counts.platinum;
      document.getElementById('countOr').textContent = counts.gold;
      document.getElementById('countArgent').textContent = counts.silver;
      document.getElementById('countBronze').textContent = counts.bronze;
      document.getElementById('countFer').textContent = counts.iron;

      // Badge principal (Champion) - basÃ© sur meData.badge
      const badgeInfo = meData?.badge;
      const gamesPlayed = badgeInfo?.gamesPlayed || 0;
      const tierLabels = getTierLabels();
      
      if (gamesPlayed >= 1 && badgeInfo?.tier) {
        // Joueur a jouÃ©, afficher son badge
        const tierFile = TIER_FILES[badgeInfo.tier] || 'fer';
        mainBadgeImg.src = `/images/badges/${tierFile}.png`;
        mainBadgeImg.style.display = '';
        mainBadgeRank.textContent = badgeInfo.rank ? `#${badgeInfo.rank}` : tierLabels[badgeInfo.tier] || '';
      } else {
        // Pas encore jouÃ© - masquer le badge
        mainBadgeImg.style.display = 'none';
        mainBadgeRank.textContent = t('play_first_game', 'Joue ta 1Ã¨re partie !');
      }

      // Power cards
      const powerLabels = getPowerLabels();
      let html = '';
      
      // V42: Labels de volume par catÃ©gorie
      const VOLUME_LABELS = {
        H: 'parties', A: 'actions mÃ©d.', B: 'parties sab.',
        C: 'parties', D: 'potions', E: 'votes',
        F: 'dÃ©cisions', G: 'tirs', I: 'sÃ©rie max'
      };
      
      for (const k of order) {
        const p = powers[k] || { scoreRaw: 0, scoreFinal: 0, eligible: false, volume: 0 };
        const [title, desc] = powerLabels[k] || [k, ''];
        const icon = POWER_ICONS[k] || 'â­';
        
        // V42: Afficher scoreRaw pour les badges individuels, scoreFinal pour Champion
        const isChampion = (k === 'H');
        const displayScore = isChampion ? Math.round(p.scoreFinal || 0) : Math.round(p.scoreRaw || 0);
        const displayTier = isChampion ? p.tier : getTierFromScore(p.scoreRaw || 0);
        const volume = p.volume || 0;
        
        // V42: SÃ©rie de victoires â†’ afficher le nombre, pas un %
        const isStreak = (k === 'I');
        const badgeDisplay = isStreak 
          ? renderStreakNumber(volume)
          : renderProgressCircle(displayScore);
        
        // V42: Info volume sous le tier
        const volLabel = VOLUME_LABELS[k] || '';
        const volDisplay = isStreak ? '' : `<div class="power-volume">${volume} ${volLabel}</div>`;
        
        html += `
          <div class="power-card">
            <div class="power-header">
              <div>
                <span class="power-icon">${icon}</span>
                <span class="power-title">${title}</span>
                <div class="power-desc">${desc}</div>
              </div>
              <div class="power-badge">
                ${badgeDisplay}
              </div>
            </div>
            <div class="power-rank">
              ${renderTierBadge(displayTier, p.rank)}
              ${volDisplay}
            </div>
          </div>
        `;
      }
      powerGrid.innerHTML = html || `<div class="loading">${t('no_data', 'Aucune donnÃ©e disponible')}</div>`;
    }

    function renderPostgame() {
      const container = document.getElementById('postgameContent');
      const params = getUrlParams();
      
      // Si on a des donnÃ©es postgame (via URL avec room), les afficher
      if (params.room && postgameData && postgameData.report) {
        renderPostgameReport(postgameData.report);
        return;
      }
      
      // Sinon, afficher la derniÃ¨re partie depuis l'historique
      const matchHistory = meData?.stats?.matchHistory || [];
      if (matchHistory.length > 0) {
        const lastMatch = matchHistory[0]; // Le plus rÃ©cent
        renderHistoryMatch(lastMatch);
        return;
      }
      
      // Aucune donnÃ©e disponible
      container.innerHTML = `
        <div style="text-align:center;padding:40px;">
          <p style="color:var(--text-muted);margin-bottom:16px;">
            ${t('no_game_history', 'Aucun historique de partie disponible. Joue une partie pour voir tes stats ici !')}
          </p>
          <a href="/game.html" class="btn-stats primary">${t('play_a_game', 'ğŸ® Jouer une partie')}</a>
        </div>
      `;
    }
    
    function renderPostgameReport(report) {
      const container = document.getElementById('postgameContent');
      
      if (!report) {
        container.innerHTML = '<div class="loading">Rapport introuvable</div>';
        return;
      }

      const winner = report.winner || 'unknown';
      const duration = report.gameDuration ? Math.round(report.gameDuration / 1000) : 0;
      const mins = Math.floor(duration / 60);
      const secs = duration % 60;
      
      // Adapter les noms selon le thÃ¨me
      const teamNames = getTeamNames();
      const winnerText = (winner === 'astronauts' || winner === 'astronautes' || winner === 'ASTRONAUTES') 
        ? `Victoire des ${teamNames.astronaut}s !`
        : (winner === 'saboteurs' || winner === 'SABOTEURS') 
          ? `Victoire des ${teamNames.saboteur}s !`
          : winner === 'AMOUREUX' 
            ? 'Victoire des Amoureux !'
            : 'Partie terminÃ©e';

      let html = `
        <div style="background:var(--bg-card);border:1px solid var(--border-soft);border-radius:16px;padding:20px;margin-bottom:20px;">
          <h2 style="margin:0 0 12px;color:var(--neon-main);">
            ğŸ† ${winnerText}
          </h2>
          <p style="color:var(--text-muted);margin:0;">DurÃ©e : ${mins}min ${secs}s</p>
        </div>
      `;

      // Liste des joueurs
      if (report.players && report.players.length > 0) {
        html += '<div class="power-grid">';
        for (const p of report.players) {
          const isWinner = p.win || (p.team === winner);
          html += `
            <div class="power-card" style="${isWinner ? 'border-color:var(--neon-main);' : ''}">
              <div class="power-header">
                <div>
                  <span class="power-icon">${p.alive ? 'âœ…' : 'ğŸ’€'}</span>
                  <span class="power-title">${p.name}</span>
                  <div class="power-desc">${p.role || 'Inconnu'} ${isWinner ? 'ğŸ†' : ''}</div>
                </div>
              </div>
            </div>
          `;
        }
        html += '</div>';
      }

      container.innerHTML = html;
    }
    
    function renderHistoryMatch(match) {
      const container = document.getElementById('postgameContent');
      const teamNames = getTeamNames();
      
      // Formater la date
      const date = match.date ? new Date(match.date) : new Date();
      const dateStr = date.toLocaleDateString(getCurrentLang(), { 
        day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' 
      });
      
      // DurÃ©e
      const duration = match.duration ? Math.round(match.duration / 1000) : 0;
      const mins = Math.floor(duration / 60);
      const secs = duration % 60;
      
      // RÃ©sultat
      const isWin = match.win;
      const resultIcon = isWin ? 'ğŸ†' : 'ğŸ’€';
      const resultText = isWin ? t('victory', 'Victoire !') : t('defeat', 'DÃ©faite');
      const resultColor = isWin ? 'var(--neon-main)' : '#ff6b6b';
      
      // RÃ´le adaptÃ© au thÃ¨me
      const roleDisplay = match.role || 'Inconnu';
      
      let html = `
        <div style="text-align:center;margin-bottom:20px;">
          <p style="color:var(--text-muted);font-size:0.9rem;margin:0 0 8px;">${t('last_game', 'DerniÃ¨re partie')} - ${dateStr}</p>
        </div>
        
        <div style="background:var(--bg-card);border:1px solid var(--border-soft);border-radius:16px;padding:24px;margin-bottom:20px;text-align:center;">
          <div style="font-size:3rem;margin-bottom:12px;">${resultIcon}</div>
          <h2 style="margin:0 0 8px;color:${resultColor};font-size:1.8rem;">
            ${resultText}
          </h2>
          <p style="color:var(--text-muted);margin:0 0 16px;font-size:1.1rem;">
            ${t('played_as', 'JouÃ© en tant que')} <strong style="color:var(--neon-main);">${roleDisplay}</strong>
          </p>
          <div style="display:flex;justify-content:center;gap:24px;flex-wrap:wrap;">
            <div>
              <div style="font-size:1.5rem;font-weight:bold;color:var(--text-main);">${mins}:${secs.toString().padStart(2,'0')}</div>
              <div style="font-size:0.8rem;color:var(--text-muted);">${t('duration', 'DurÃ©e')}</div>
            </div>
            <div>
              <div style="font-size:1.5rem;font-weight:bold;color:var(--text-main);">${match.players || '?'}</div>
              <div style="font-size:0.8rem;color:var(--text-muted);">${t('players', 'Joueurs')}</div>
            </div>
          </div>
        </div>
        
        <div style="text-align:center;">
          <a href="/game.html" class="btn-stats primary">${t('play_again', 'ğŸ® Rejouer')}</a>
        </div>
      `;
      
      container.innerHTML = html;
    }

    async function renderLeaderboards() {
      const grid = document.getElementById('lbGrid');
      grid.innerHTML = `<div class="loading">${t('loading', 'Chargement...')}</div>`;

      const categories = [
        ["H", `ğŸ† ${t('lb_champion', 'Champion')}`, t('lb_champion_desc', 'Classement global')],
        ["A", `ğŸ§ª ${t('lb_doctor', 'Docteur')}`, t('lb_doctor_desc', 'Soins + potions')],
        ["B", `ğŸ­ ${t('lb_bluffer', 'Bluffer')}`, t('lb_bluffer_desc', 'Incognito saboteur')],
        ["C", `ğŸ›¡ï¸ ${t('lb_resistant', 'RÃ©sistant')}`, t('lb_resistant_desc', 'Taux de survie')],
        ["E", `ğŸ•µï¸ ${t('lb_investigator', 'EnquÃªteur')}`, t('lb_investigator_desc', 'Votes justes')],
        ["F", `ğŸ‘‘ ${t('lb_chief', 'Chef station')}`, t('lb_chief_desc', 'DÃ©cisions capitaine')],
        ["G", `ğŸ”« ${t('lb_security', 'SÃ©curitÃ©')}`, t('lb_security_desc', 'Vengeance')],
        ["I", `ğŸ”¥ ${t('lb_streak', 'Streak')}`, t('lb_streak_desc', 'SÃ©rie victoires')],
        ["D", `â˜ ï¸ ${t('lb_exterminator', 'Exterminateur')}`, t('lb_exterminator_desc', 'Potions sur astronautes')]
      ];

      // Charger le top 3 de chaque catÃ©gorie en parallÃ¨le
      const token = getToken();
      const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
      const myUsername = meData?.user?.username;
      
      const topData = {};
      await Promise.all(categories.map(async ([key]) => {
        try {
          const res = await fetch(`/api/stats/leaderboard?category=${key}&limit=3`, { headers });
          const data = await res.json();
          if (data.success && data.top) topData[key] = data.top;
        } catch (e) { /* ignore */ }
      }));

      let html = '';
      for (const [key, title, desc] of categories) {
        const top = topData[key] || [];
        const isStreak = (key === 'I');
        const isChampion = (key === 'H');
        
        let topHtml = '';
        if (top.length > 0) {
          topHtml = '<div class="lb-card-top">';
          for (const row of top) {
            const isMe = myUsername && row.username === myUsername;
            const score = isChampion 
              ? `${Math.round(row.scoreFinal)}/100`
              : (isStreak ? `Ã—${row.volume || 0}` : `${Math.round(row.scoreRaw || 0)}%`);
            topHtml += `
              <div class="lb-card-top-row">
                <span class="lb-card-top-rank">${row.rank}</span>
                <span class="lb-card-top-name ${isMe ? 'is-me' : ''}">${row.username}</span>
                <span class="lb-card-top-score">${score}</span>
              </div>`;
          }
          topHtml += '</div>';
        }
        
        html += `
          <div class="lb-card" onclick="openLeaderboardModal('${key}')">
            <div class="lb-card-title">${title}</div>
            <div class="lb-card-desc">${desc}</div>
            ${topHtml}
            <div class="lb-card-count">${t('lb_view', 'Voir le classement')} â†’</div>
          </div>
        `;
      }
      grid.innerHTML = html;
    }

    async function openLeaderboardModal(category) {
      const modal = document.getElementById('lbModal');
      const title = document.getElementById('modalTitle');
      const body = document.getElementById('modalBody');
      
      const powerLabels = getPowerLabels();
      const [, label] = Object.entries(powerLabels).find(([k]) => k === category) || [category, [category]];
      title.textContent = `${POWER_ICONS[category] || ''} ${label[0]}`;
      body.innerHTML = `<div class="loading">${t('loading', 'Chargement...')}</div>`;
      modal.classList.add('active');

      // V42: Labels de volume pour chaque catÃ©gorie
      const VOLUME_HEADERS = {
        H: t('lb_vol_games', 'Parties'), 
        A: t('lb_vol_actions', 'Actions'), 
        B: t('lb_vol_sab_games', 'Parties sab.'),
        C: t('lb_vol_games', 'Parties'), 
        D: t('lb_vol_potions', 'Potions'), 
        E: t('lb_vol_votes', 'Votes'),
        F: t('lb_vol_decisions', 'DÃ©cisions'), 
        G: t('lb_vol_shots', 'Tirs'), 
        I: t('lb_vol_streak', 'SÃ©rie')
      };
      const isStreak = (category === 'I');
      const isChampion = (category === 'H');

      try {
        const token = getToken();
        const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
        const res = await fetch(`/api/stats/leaderboard?category=${category}&limit=50`, { headers });
        const data = await res.json();

        if (!data.success || !data.top || data.top.length === 0) {
          body.innerHTML = `<p style="text-align:center;color:var(--text-muted);">${t('no_players_ranked', 'Aucun joueur classÃ©')}</p>`;
          return;
        }

        let html = `
          <table class="lb-table">
            <thead>
              <tr>
                <th>${t('rank', '#')}</th>
                <th>${t('player', 'Joueur')}</th>
                <th>${t('badge', 'Badge')}</th>
                <th>${isStreak ? 'SÃ©rie' : t('score', 'Score')}</th>
                <th>${VOLUME_HEADERS[category] || 'Volume'}</th>
              </tr>
            </thead>
            <tbody>
        `;

        for (const row of data.top) {
          const isMe = meData?.user?.username === row.username;
          // V42: Afficher scoreRaw pour individuels, scoreFinal pour Champion
          const displayScore = isChampion 
            ? `${Math.round(row.scoreFinal)}/100`
            : (isStreak ? `Ã—${row.volume || 0}` : `${Math.round(row.scoreRaw || 0)}%`);
          const volumeDisplay = isStreak ? `${Math.round(row.scoreFinal)}/100` : (row.volume || 0);
          
          html += `
            <tr class="${isMe ? 'me' : ''}">
              <td><strong>${row.rank}</strong></td>
              <td>${row.username}</td>
              <td>${renderTierBadge(row.tier, null)}</td>
              <td>${displayScore}</td>
              <td style="color:var(--text-muted);font-size:0.85em;">${volumeDisplay}</td>
            </tr>
          `;
        }

        html += '</tbody></table>';
        body.innerHTML = html;
      } catch (e) {
        body.innerHTML = '<p style="color:#ff6b6b;">Erreur de chargement</p>';
      }
    }

    function closeModal() {
      document.getElementById('lbModal').classList.remove('active');
    }

    function showExplanations() {
      document.getElementById('explanationsModal').classList.add('active');
    }

    function closeExplanations() {
      document.getElementById('explanationsModal').classList.remove('active');
    }

    async function renderArchives() {
      const container = document.getElementById('archivesContent');
      container.innerHTML = '<div class="loading">Chargement...</div>';

      try {
        const res = await fetch('/api/stats/snapshots');
        const data = await res.json();

        if (!data.success || !data.months || data.months.length === 0) {
          container.innerHTML = '<p style="text-align:center;color:var(--text-muted);">Aucun snapshot mensuel disponible</p>';
          return;
        }

        let html = '<div class="lb-grid">';
        for (const month of data.months) {
          html += `
            <div class="lb-card" onclick="viewSnapshot('${month}')">
              <div class="lb-card-title">ğŸ“… ${month}</div>
              <div class="lb-card-desc">Classement officiel du mois</div>
              <div class="lb-card-count">Voir â†’</div>
            </div>
          `;
        }
        html += '</div>';
        container.innerHTML = html;
      } catch (e) {
        container.innerHTML = '<p style="color:#ff6b6b;">Erreur de chargement</p>';
      }
    }

    async function viewSnapshot(month) {
      const modal = document.getElementById('lbModal');
      const title = document.getElementById('modalTitle');
      const body = document.getElementById('modalBody');
      
      title.textContent = `ğŸ“… Classement ${month}`;
      body.innerHTML = '<div class="loading">Chargement...</div>';
      modal.classList.add('active');

      try {
        const res = await fetch(`/api/stats/snapshot/${month}`);
        const data = await res.json();

        if (!data.success || !data.snapshot) {
          body.innerHTML = '<p style="color:var(--text-muted);">Snapshot introuvable</p>';
          return;
        }

        let html = '';
        for (const [catKey, catData] of Object.entries(data.snapshot.categories || {})) {
          html += `<h3 style="margin:20px 0 10px;">${POWER_ICONS[catKey] || ''} ${catData.title}</h3>`;
          
          if (catData.top50 && catData.top50.length > 0) {
            html += '<table class="lb-table"><thead><tr><th>#</th><th>Joueur</th><th>Score</th></tr></thead><tbody>';
            for (const row of catData.top50.slice(0, 10)) {
              html += `<tr><td>${row.rank}</td><td>${row.username}</td><td>${row.scoreFinal}</td></tr>`;
            }
            html += '</tbody></table>';
          } else {
            html += '<p style="color:var(--text-muted);">Aucun classÃ©</p>';
          }
        }
        body.innerHTML = html || '<p>DonnÃ©es vides</p>';
      } catch (e) {
        body.innerHTML = '<p style="color:#ff6b6b;">Erreur de chargement</p>';
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // V11: ONGLET DÃ‰TAILLÃ‰ - Camemberts et stats dÃ©taillÃ©es
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    let detailedCharts = { wins: null, losses: null };
    
    function renderDetailed() {
      const container = document.getElementById('detailedContent');
      if (!meData || !meData.stats) {
        container.innerHTML = '<div class="no-data-message">Connecte-toi pour voir tes statistiques dÃ©taillÃ©es</div>';
        return;
      }
      
      const stats = meData.stats;
      const gamesByRole = stats.gamesByRole || {};
      const winsByRole = stats.winsByRole || {};
      
      // Calculer les dÃ©faites par rÃ´le
      const lossesByRole = {};
      for (const [role, games] of Object.entries(gamesByRole)) {
        const wins = winsByRole[role] || 0;
        lossesByRole[role] = games - wins;
      }
      
      // Couleurs pour les rÃ´les
      const roleColors = {
        astronaut: '#4ade80', crewmate: '#4ade80', villageois: '#4ade80', etudiant: '#4ade80', mortel: '#4ade80',
        doctor: '#60a5fa', docteur: '#60a5fa', sorciere: '#60a5fa', guerisseur: '#60a5fa', apollon: '#60a5fa',
        security: '#f59e0b', chef_securite: '#f59e0b', chasseur: '#f59e0b', ares: '#f59e0b',
        radar: '#a78bfa', officier_radar: '#a78bfa', voyante: '#a78bfa', oracle: '#a78bfa', athena: '#a78bfa',
        ai_agent: '#ec4899', liaison_ia: '#ec4899', cupidon: '#ec4899', aphrodite: '#ec4899',
        chameleon: '#14b8a6', cameleon: '#14b8a6', salvateur: '#14b8a6', hermes: '#14b8a6',
        engineer: '#6366f1', ingenieur: '#6366f1', ancien: '#6366f1', hephaÃ¯stos: '#6366f1',
        saboteur: '#ef4444', loup_garou: '#ef4444', imposteur: '#ef4444', sorcier_noir: '#ef4444', titan: '#ef4444'
      };
      
      // Fonction pour obtenir le nom traduit d'un rÃ´le
      const getRoleName = (roleKey) => {
        const roleNames = {
          astronaut: 'Astronaute', crewmate: 'Ã‰quipier', villageois: 'Villageois', etudiant: 'Ã‰tudiant', mortel: 'Mortel',
          doctor: 'Docteur', sorciere: 'SorciÃ¨re', guerisseur: 'GuÃ©risseur', apollon: 'Apollon',
          security: 'Chef SÃ©curitÃ©', chasseur: 'Chasseur', ares: 'ArÃ¨s',
          radar: 'Officier Radar', voyante: 'Voyante', oracle: 'Oracle', athena: 'AthÃ©na',
          ai_agent: 'Agent IA', cupidon: 'Cupidon', aphrodite: 'Aphrodite',
          chameleon: 'CamÃ©lÃ©on', salvateur: 'Salvateur', hermes: 'HermÃ¨s',
          engineer: 'IngÃ©nieur', ancien: 'Ancien', hephaÃ¯stos: 'HÃ©phaÃ¯stos',
          saboteur: 'Saboteur', loup_garou: 'Loup-Garou', imposteur: 'Imposteur', sorcier_noir: 'Sorcier Noir', titan: 'Titan'
        };
        return roleNames[roleKey] || roleKey;
      };
      
      // PrÃ©parer les donnÃ©es pour les camemberts
      const winsData = Object.entries(winsByRole).filter(([_, v]) => v > 0);
      const lossesData = Object.entries(lossesByRole).filter(([_, v]) => v > 0);
      
      // Stats dÃ©taillÃ©es
      const correctVotes = stats.correctSaboteurVotes || 0;
      const wrongVotes = stats.wrongSaboteurVotes || 0;
      const totalVotes = stats.totalVotes || 0;
      
      const revengeKillsSab = stats.revengeKillsOnSaboteurs || 0;
      const revengeKillsInn = stats.revengeKillsOnInnocents || 0;
      const totalRevengeShots = stats.securityRevengeShots || 0;
      
      const doctorKillsSab = stats.doctorKillsOnSaboteurs || 0;
      const doctorKillsInn = stats.doctorKillsOnInnocents || 0;
      const totalDoctorKills = stats.doctorKills || 0;
      const doctorSaves = stats.doctorSaves || 0;
      const doctorNotSavedOpp = stats.doctorNotSavedOpportunities || 0;
      const doctorMissed = stats.doctorMissedSaves || 0;
      
      const mayorOk = stats.mayorTiebreakerOk || 0;
      const mayorKo = stats.mayorTiebreakerKo || 0;
      const mayorTotal = stats.mayorTiebreakerTotal || 0;
      const captainTransferTotal = stats.captainTransferTotal || 0;
      const captainTransferToAst = stats.captainTransferToAstronauts || 0;
      const captainTransferToSab = stats.captainTransferToSaboteurs || 0;
      
      // Helper pour calculer les pourcentages
      const pct = (num, total) => total > 0 ? Math.round((num / total) * 100) : 0;
      
      // GÃ©nÃ©rer le HTML
      container.innerHTML = `
        <!-- Camemberts Victoires/DÃ©faites par rÃ´le -->
        <div class="detailed-section">
          <div class="detailed-section-title">ğŸ“Š RÃ©partition par rÃ´le</div>
          <div class="charts-row">
            <div class="chart-card">
              <h3>ğŸ† Victoires par rÃ´le</h3>
              <div class="chart-container">
                <canvas id="winsChart"></canvas>
              </div>
              <div class="chart-legend" id="winsLegend"></div>
            </div>
            <div class="chart-card">
              <h3>ğŸ’€ DÃ©faites par rÃ´le</h3>
              <div class="chart-container">
                <canvas id="lossesChart"></canvas>
              </div>
              <div class="chart-legend" id="lossesLegend"></div>
            </div>
          </div>
        </div>
        
        <!-- Stats dÃ©taillÃ©es -->
        <div class="detailed-section">
          <div class="detailed-section-title">ğŸ¯ Statistiques de combat</div>
          <div class="stats-grid">
            
            <!-- Combat VS Saboteurs -->
            <div class="stat-card">
              <div class="stat-card-title">ğŸ¯ Combat VS Saboteurs</div>
              <div class="stat-row">
                <span class="stat-label">Votes corrects</span>
                <span class="stat-value good">${correctVotes}/${totalVotes} (${pct(correctVotes, totalVotes)}%)</span>
              </div>
              <div class="stat-bar-container">
                <div class="stat-bar good" style="width: ${pct(correctVotes, totalVotes)}%"></div>
              </div>
              <div class="stat-row">
                <span class="stat-label">Votes faux</span>
                <span class="stat-value bad">${wrongVotes}/${totalVotes} (${pct(wrongVotes, totalVotes)}%)</span>
              </div>
              <div class="stat-bar-container">
                <div class="stat-bar bad" style="width: ${pct(wrongVotes, totalVotes)}%"></div>
              </div>
            </div>
            
            <!-- Chef de SÃ©curitÃ© -->
            <div class="stat-card">
              <div class="stat-card-title">ğŸ”« Chef de SÃ©curitÃ©</div>
              <div class="stat-row">
                <span class="stat-label">Saboteurs Ã©liminÃ©s</span>
                <span class="stat-value good">${revengeKillsSab}/${totalRevengeShots} (${pct(revengeKillsSab, totalRevengeShots)}%)</span>
              </div>
              <div class="stat-bar-container">
                <div class="stat-bar good" style="width: ${pct(revengeKillsSab, totalRevengeShots)}%"></div>
              </div>
              <div class="stat-row">
                <span class="stat-label">Astronautes Ã©liminÃ©s (err)</span>
                <span class="stat-value bad">${revengeKillsInn}/${totalRevengeShots} (${pct(revengeKillsInn, totalRevengeShots)}%)</span>
              </div>
              <div class="stat-bar-container">
                <div class="stat-bar bad" style="width: ${pct(revengeKillsInn, totalRevengeShots)}%"></div>
              </div>
            </div>
            
            <!-- Docteur -->
            <div class="stat-card">
              <div class="stat-card-title">ğŸ’Š Docteur / SorciÃ¨re</div>
              <div class="stat-row">
                <span class="stat-label">Potion fatale OK (saboteur)</span>
                <span class="stat-value good">${doctorKillsSab}/${totalDoctorKills} (${pct(doctorKillsSab, totalDoctorKills)}%)</span>
              </div>
              <div class="stat-bar-container">
                <div class="stat-bar good" style="width: ${pct(doctorKillsSab, totalDoctorKills)}%"></div>
              </div>
              <div class="stat-row">
                <span class="stat-label">Potion fatale err (astronaute)</span>
                <span class="stat-value bad">${doctorKillsInn}/${totalDoctorKills} (${pct(doctorKillsInn, totalDoctorKills)}%)</span>
              </div>
              <div class="stat-bar-container">
                <div class="stat-bar bad" style="width: ${pct(doctorKillsInn, totalDoctorKills)}%"></div>
              </div>
              <div class="stat-row">
                <span class="stat-label">Potions de vie utilisÃ©es</span>
                <span class="stat-value">${doctorSaves}</span>
              </div>
              <div class="stat-row">
                <span class="stat-label">Non sauvÃ©s (opportunitÃ©s manquÃ©es)</span>
                <span class="stat-value">${doctorMissed}/${doctorNotSavedOpp}</span>
              </div>
            </div>
            
            <!-- Actions du Capitaine -->
            <div class="stat-card">
              <div class="stat-card-title">ğŸ‘‘ Actions du Capitaine</div>
              <div class="stat-row">
                <span class="stat-label">DÃ©partage OK (tuÃ© saboteur)</span>
                <span class="stat-value good">${mayorOk}/${mayorTotal} (${pct(mayorOk, mayorTotal)}%)</span>
              </div>
              <div class="stat-bar-container">
                <div class="stat-bar good" style="width: ${pct(mayorOk, mayorTotal)}%"></div>
              </div>
              <div class="stat-row">
                <span class="stat-label">DÃ©partage KO (tuÃ© astronaute)</span>
                <span class="stat-value bad">${mayorKo}/${mayorTotal} (${pct(mayorKo, mayorTotal)}%)</span>
              </div>
              <div class="stat-bar-container">
                <div class="stat-bar bad" style="width: ${pct(mayorKo, mayorTotal)}%"></div>
              </div>
              <div class="stat-row">
                <span class="stat-label">Transfert OK (Ã  astronaute)</span>
                <span class="stat-value good">${captainTransferToAst}/${captainTransferTotal} (${pct(captainTransferToAst, captainTransferTotal)}%)</span>
              </div>
              <div class="stat-bar-container">
                <div class="stat-bar good" style="width: ${pct(captainTransferToAst, captainTransferTotal)}%"></div>
              </div>
              <div class="stat-row">
                <span class="stat-label">Transfert KO (Ã  saboteur)</span>
                <span class="stat-value bad">${captainTransferToSab}/${captainTransferTotal} (${pct(captainTransferToSab, captainTransferTotal)}%)</span>
              </div>
              <div class="stat-bar-container">
                <div class="stat-bar bad" style="width: ${pct(captainTransferToSab, captainTransferTotal)}%"></div>
              </div>
            </div>
            
          </div>
        </div>
        
        <!-- Tableau des victoires par rÃ´le -->
        <div class="detailed-section">
          <div class="detailed-section-title">ğŸ“ˆ DÃ©tail par rÃ´le</div>
          <div class="stat-card">
            <table style="width:100%; border-collapse:collapse;">
              <thead>
                <tr style="border-bottom: 2px solid var(--border-soft);">
                  <th style="text-align:left; padding:12px 8px; color:var(--text-muted);">RÃ´le</th>
                  <th style="text-align:center; padding:12px 8px; color:var(--text-muted);">Parties</th>
                  <th style="text-align:center; padding:12px 8px; color:var(--text-muted);">Victoires</th>
                  <th style="text-align:center; padding:12px 8px; color:var(--text-muted);">DÃ©faites</th>
                  <th style="text-align:center; padding:12px 8px; color:var(--text-muted);">Win Rate</th>
                </tr>
              </thead>
              <tbody>
                ${Object.entries(gamesByRole).map(([role, games]) => {
                  const wins = winsByRole[role] || 0;
                  const losses = games - wins;
                  const wr = pct(wins, games);
                  const color = roleColors[role] || '#888';
                  return `
                    <tr style="border-bottom: 1px solid var(--border-soft);">
                      <td style="padding:10px 8px;">
                        <span style="display:inline-block; width:10px; height:10px; border-radius:3px; background:${color}; margin-right:8px;"></span>
                        ${getRoleName(role)}
                      </td>
                      <td style="text-align:center; padding:10px 8px;">${games}</td>
                      <td style="text-align:center; padding:10px 8px; color:#4ade80;">${wins}</td>
                      <td style="text-align:center; padding:10px 8px; color:#f87171;">${losses}</td>
                      <td style="text-align:center; padding:10px 8px; font-weight:700;">${wr}%</td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
      
      // CrÃ©er les camemberts avec Chart.js
      setTimeout(() => {
        createPieChart('winsChart', 'winsLegend', winsData, roleColors, getRoleName);
        createPieChart('lossesChart', 'lossesLegend', lossesData, roleColors, getRoleName);
      }, 100);
    }
    
    function createPieChart(canvasId, legendId, data, colors, getLabel) {
      const canvas = document.getElementById(canvasId);
      const legendContainer = document.getElementById(legendId);
      
      if (!canvas || data.length === 0) {
        if (legendContainer) {
          legendContainer.innerHTML = '<span style="color:var(--text-muted);">Aucune donnÃ©e</span>';
        }
        return;
      }
      
      const labels = data.map(([role]) => getLabel(role));
      const values = data.map(([_, v]) => v);
      const bgColors = data.map(([role]) => colors[role] || '#888888');
      
      // DÃ©truire le chart existant si prÃ©sent
      const chartKey = canvasId.includes('wins') ? 'wins' : 'losses';
      if (detailedCharts[chartKey]) {
        detailedCharts[chartKey].destroy();
      }
      
      detailedCharts[chartKey] = new Chart(canvas, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: values,
            backgroundColor: bgColors,
            borderColor: 'rgba(0,0,0,0.3)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                  const pct = Math.round((ctx.raw / total) * 100);
                  return `${ctx.label}: ${ctx.raw} (${pct}%)`;
                }
              }
            }
          }
        }
      });
      
      // GÃ©nÃ©rer la lÃ©gende personnalisÃ©e
      legendContainer.innerHTML = data.map(([role, value]) => `
        <div class="legend-item">
          <span class="legend-color" style="background:${colors[role] || '#888'}"></span>
          <span>${getLabel(role)}: ${value}</span>
        </div>
      `).join('');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // NAVIGATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function switchTab(viewId) {
      // Update tabs
      document.querySelectorAll('.stats-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.view === viewId);
      });

      // Update views
      document.querySelectorAll('.view').forEach(view => {
        view.classList.toggle('active', view.id === `view${viewId.charAt(0).toUpperCase() + viewId.slice(1)}`);
      });

      // Load data if needed
      if (viewId === 'leaderboards') {
        renderLeaderboards();
      } else if (viewId === 'archives') {
        renderArchives();
      } else if (viewId === 'detailed') {
        renderDetailed();
      }
      // V42: postgame supprimÃ©, plus besoin de le gÃ©rer
    }

    function backToGame() {
      const params = getUrlParams();
      const isPostgame = (params.mode || '').toLowerCase() === 'postgame';
      
      // V42: Si on vient du mode postgame (nouvel onglet), fermer l'onglet
      if (isPostgame) {
        window.close();
        // Si window.close() ne fonctionne pas (certains navigateurs), fallback
        setTimeout(() => {
          window.location.href = '/game.html';
        }, 100);
      } else {
        const stored = sessionStorage.getItem('saboteur_return_to_game_url');
        if (stored) {
          window.location.href = stored;
        } else {
          window.location.href = '/game.html';
        }
      }
    }

    function maybeShowBackButton() {
      const params = getUrlParams();
      const isPostgame = (params.mode || '').toLowerCase() === 'postgame';
      document.getElementById('btnBackToGame').style.display = isPostgame ? '' : 'none';
      
      // V42: Onglet postgame supprimÃ©, on reste sur "profile"
      // Le bouton "Retour Ã  la partie" reste visible si mode=postgame
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // DATA FETCHING
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    async function fetchMeStats() {
      const token = getToken();
      if (!token) return null;

      try {
        const res = await fetch('/api/stats/me', { 
          headers: { 'Authorization': `Bearer ${token}` } 
        });
        if (!res.ok) return null;
        return await res.json();
      } catch (e) {
        console.error('fetchMeStats error:', e);
        return null;
      }
    }

    async function fetchPostgame() {
      const params = getUrlParams();
      if (!params.room) return null;

      try {
        const token = getToken();
        const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
        const url = `/api/stats/postgame/${params.room}${params.pt ? `?pt=${params.pt}` : ''}`;
        const res = await fetch(url, { headers });
        if (!res.ok) return null;
        return await res.json();
      } catch (e) {
        console.error('fetchPostgame error:', e);
        return null;
      }
    }

    async function refreshAll() {
      // Fetch me stats
      meData = await fetchMeStats();
      renderProfile();
      
      // V42: Postgame supprimÃ©, plus besoin de charger ces donnÃ©es
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // INIT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    document.addEventListener('DOMContentLoaded', () => {
      applyTheme();
      maybeShowBackButton();
      refreshAll();

      // V11: Ouvrir l'onglet spÃ©cifiÃ© dans l'URL (ex: ?tab=detailed)
      const params = getUrlParams();
      if (params.tab) {
        const validTabs = ['profile', 'detailed', 'leaderboards', 'archives'];
        if (validTabs.includes(params.tab)) {
          setTimeout(() => switchTab(params.tab), 300);
        }
      }

      // Close modal on overlay click
      document.getElementById('lbModal').addEventListener('click', (e) => {
        if (e.target.id === 'lbModal') closeModal();
      });
      
      document.getElementById('explanationsModal').addEventListener('click', (e) => {
        if (e.target.id === 'explanationsModal') closeExplanations();
      });

      // Escape key closes modals
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeModal();
          closeExplanations();
        }
      });
    });
  </script>
  
  <!-- Traductions -->
  <script src="/site-translations.js"></script>
  <script>
    // Appliquer les traductions au chargement
    if (typeof applySiteTranslations === 'function') {
      applySiteTranslations();
    }
  </script>
</body>
</html>
