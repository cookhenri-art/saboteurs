<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ” Admin Panel - Saboteur</title>
  <meta name="robots" content="noindex, nofollow">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3e 100%);
      color: #fff;
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    h1 {
      text-align: center;
      margin-bottom: 30px;
      color: #00ffff;
    }
    
    /* Login Screen */
    #loginScreen {
      max-width: 400px;
      margin: 100px auto;
      background: rgba(0, 0, 0, 0.5);
      padding: 40px;
      border-radius: 15px;
      border: 2px solid #333;
    }
    
    #loginScreen h2 {
      text-align: center;
      margin-bottom: 30px;
      color: #ff6600;
    }
    
    /* Admin Panel */
    #adminPanel {
      display: none;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: rgba(0, 255, 255, 0.1);
      border: 1px solid rgba(0, 255, 255, 0.3);
      border-radius: 10px;
      padding: 20px;
      text-align: center;
    }
    
    .stat-card .number {
      font-size: 2.5em;
      font-weight: bold;
      color: #00ffff;
    }
    
    .stat-card .label {
      color: rgba(255, 255, 255, 0.7);
      font-size: 0.9em;
    }
    
    .section {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 20px;
      border: 1px solid #333;
    }
    
    .section h3 {
      margin-bottom: 20px;
      color: #00ff88;
      border-bottom: 1px solid #333;
      padding-bottom: 10px;
    }
    
    .form-row {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    
    input, select {
      padding: 12px 15px;
      border: 1px solid #444;
      border-radius: 8px;
      background: rgba(0, 0, 0, 0.5);
      color: #fff;
      font-size: 1em;
      flex: 1;
      min-width: 150px;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: #00ffff;
    }
    
    button {
      padding: 12px 25px;
      border: none;
      border-radius: 8px;
      font-size: 1em;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: bold;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #00ffff, #0099cc);
      color: #000;
    }
    
    .btn-success {
      background: linear-gradient(135deg, #00ff88, #00cc6a);
      color: #000;
    }
    
    .btn-warning {
      background: linear-gradient(135deg, #ff6600, #ff9900);
      color: #000;
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #ff4444, #cc0000);
      color: #fff;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    /* Users Table */
    .users-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    
    .users-table th, .users-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #333;
    }
    
    .users-table th {
      background: rgba(0, 255, 255, 0.1);
      color: #00ffff;
    }
    
    .users-table tr:hover {
      background: rgba(255, 255, 255, 0.05);
    }
    
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.8em;
      font-weight: bold;
    }
    
    .badge-admin { background: #ff6600; color: #000; }
    .badge-subscriber { background: #00ff88; color: #000; }
    .badge-pack { background: #00ffff; color: #000; }
    .badge-free { background: #666; color: #fff; }
    
    .verified { color: #00ff88; }
    .not-verified { color: #ff6666; }
    
    /* Result message */
    .result {
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      display: none;
    }
    
    .result.success {
      background: rgba(0, 255, 136, 0.2);
      border: 1px solid #00ff88;
      color: #00ff88;
    }
    
    .result.error {
      background: rgba(255, 68, 68, 0.2);
      border: 1px solid #ff4444;
      color: #ff4444;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .users-table {
        font-size: 0.85em;
      }
      
      .users-table th, .users-table td {
        padding: 8px;
      }
    }
    
    .logout-btn {
      position: fixed;
      top: 20px;
      right: 20px;
    }
    
    .action-btn {
      padding: 5px 10px;
      font-size: 0.8em;
      margin: 2px;
    }
  </style>
</head>
<body>
  <div class="container">
    
    <!-- Login Screen -->
    <div id="loginScreen">
      <h2>ğŸ” Admin Panel</h2>
      <input type="password" id="secretInput" placeholder="Code secret admin" onkeypress="if(event.key==='Enter') login()">
      <button class="btn-primary" style="width: 100%; margin-top: 15px;" onclick="login()">
        AccÃ©der
      </button>
      <div id="loginResult" class="result"></div>
    </div>
    
    <!-- Admin Panel -->
    <div id="adminPanel">
      <button class="btn-danger logout-btn" onclick="logout()">ğŸšª DÃ©connexion</button>
      
      <h1>ğŸ” Saboteur Admin Panel</h1>
      
      <!-- Admin Stripe Button -->
      <div style="text-align: center; margin: 20px 0 30px 0;">
        <a href="#" onclick="goToStripeAdmin(); return false;" style="
          display: inline-block;
          padding: 15px 30px;
          background: linear-gradient(135deg, #00ffff 0%, #00ccff 100%);
          color: #000;
          text-decoration: none;
          border-radius: 10px;
          font-weight: bold;
          font-size: 1.1em;
          box-shadow: 0 4px 15px rgba(0, 255, 255, 0.3);
          transition: all 0.3s;
          border: none;
        " onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 6px 20px rgba(0, 255, 255, 0.5)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(0, 255, 255, 0.3)';">
          ğŸ’³ GÃ©rer Stripe (Paiements, Promos, RÃ©compenses)
        </a>
      </div>
      
      <!-- V35: Stats Serveur -->
      <div class="stats-grid" id="serverStatsGrid" style="margin-bottom: 20px; background: linear-gradient(135deg, #1a1a2e 0%, #0f3460 100%); padding: 15px; border-radius: 12px;">
        <div class="stat-card" style="background: rgba(0,255,136,0.1); border-color: #00ff88;">
          <div class="number" id="statUptime" style="color: #00ff88;">-</div>
          <div class="label">â±ï¸ Uptime</div>
        </div>
        <div class="stat-card" style="background: rgba(255,165,0,0.1); border-color: #ffa500;">
          <div class="number" id="statMemory" style="color: #ffa500;">-</div>
          <div class="label">ğŸ’¾ MÃ©moire (MB)</div>
        </div>
        <div class="stat-card" style="background: rgba(0,255,255,0.1); border-color: #00ffff;">
          <div class="number" id="statRooms" style="color: #00ffff;">-</div>
          <div class="label">ğŸšª Rooms actives</div>
        </div>
        <div class="stat-card" style="background: rgba(255,0,255,0.1); border-color: #ff00ff;">
          <div class="number" id="statPlayers" style="color: #ff00ff;">-</div>
          <div class="label">ğŸ‘¥ Joueurs connectÃ©s</div>
        </div>
      </div>
      
      <!-- Stats Utilisateurs -->
      <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
          <div class="number" id="statTotal">-</div>
          <div class="label">Utilisateurs</div>
        </div>
        <div class="stat-card">
          <div class="number" id="statVerified">-</div>
          <div class="label">VÃ©rifiÃ©s</div>
        </div>
        <div class="stat-card">
          <div class="number" id="statSubscribers">-</div>
          <div class="label">Subscribers</div>
        </div>
        <div class="stat-card">
          <div class="number" id="statPacks">-</div>
          <div class="label">Packs</div>
        </div>
        <div class="stat-card">
          <div class="number" id="statAdmins">-</div>
          <div class="label">Admins</div>
        </div>
      </div>
      
      <!-- Upgrade User -->
      <div class="section">
        <h3>â¬†ï¸ Upgrade / Modifier un compte</h3>
        <div class="form-row">
          <input type="email" id="upgradeEmail" placeholder="Email de l'utilisateur">
          <select id="upgradeTier">
            <option value="free">Free (2 crÃ©dits)</option>
            <option value="pack">Pack (50 crÃ©dits)</option>
            <option value="subscriber">Subscriber (illimitÃ©)</option>
            <option value="admin">Admin (illimitÃ©)</option>
          </select>
          <button class="btn-success" onclick="upgradeUser()">Appliquer</button>
        </div>
        <div id="upgradeResult" class="result"></div>
      </div>
      
      <!-- Add Credits -->
      <div class="section">
        <h3>ğŸ Ajouter des crÃ©dits</h3>
        <div class="form-row">
          <input type="email" id="creditsEmail" placeholder="Email de l'utilisateur">
          <input type="number" id="creditsAmount" placeholder="Nombre de crÃ©dits" value="50" min="1">
          <button class="btn-warning" onclick="addCredits()">Ajouter</button>
        </div>
        <div id="creditsResult" class="result"></div>
      </div>
      
      <!-- Delete User -->
      <div class="section">
        <h3>ğŸ—‘ï¸ Supprimer un compte</h3>
        <div class="form-row">
          <input type="email" id="deleteEmail" placeholder="Email de l'utilisateur">
          <button class="btn-danger" onclick="deleteUser()">Supprimer</button>
        </div>
        <div id="deleteResult" class="result"></div>
      </div>
      
      <!-- V35: Reset User Avatars/Video -->
      <div class="section">
        <h3>ğŸ”„ Reset Joueur (Tests)</h3>
        <p style="color: rgba(255,255,255,0.6); margin-bottom: 15px;">Remet Ã  zÃ©ro les compteurs d'un joueur pour les tests</p>
        <div class="form-group">
          <label>ID Utilisateur</label>
          <input type="number" id="resetUserId" placeholder="ID du joueur">
        </div>
        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
          <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
            <input type="checkbox" id="resetAvatarsCheck" checked> Reset compteur avatars
          </label>
          <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
            <input type="checkbox" id="resetVideoCheck"> Reset crÃ©dits vidÃ©o
          </label>
          <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
            <input type="checkbox" id="deleteAvatarFilesCheck"> Supprimer fichiers avatars
          </label>
        </div>
        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1);">
          <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; color: #ff6b6b;">
            <input type="checkbox" id="removeFromFamilyCheck"> âš ï¸ Retirer du pack famille
          </label>
          <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; color: #ff6b6b;">
            <input type="checkbox" id="downgradeToFreeCheck"> âš ï¸ Downgrade en FREE (reset complet)
          </label>
        </div>
        <button class="btn-warning" onclick="resetUser()">ğŸ”„ Reset le joueur</button>
        <div id="resetUserResult" class="result"></div>
      </div>
      
      <!-- Clear IP Logs -->
      <div class="section">
        <h3>ğŸ”“ Reset limites IP</h3>
        <p style="color: rgba(255,255,255,0.6); margin-bottom: 15px;">Efface les limitations de crÃ©ation de compte par IP</p>
        <button class="btn-warning" onclick="clearIpLogs()">Reset limites IP</button>
        <div id="ipResult" class="result"></div>
      </div>
      
      <!-- ğŸ”´ GRAND RESET (Tests) -->
      <div class="section" style="border: 2px solid #ff4444; background: rgba(255,0,0,0.05);">
        <h3 style="color: #ff4444;">ğŸ”´ Grand Reset (Tests)</h3>
        <p style="color: rgba(255,255,255,0.6); margin-bottom: 15px;">
          <strong>âš ï¸ ATTENTION :</strong> Supprime TOUTES les donnÃ©es utilisateurs et remet les IDs Ã  1.<br>
          Utilisateurs, avatars, historiques, rewards, notifications, workflows... TOUT sera effacÃ©.
        </p>
        <button class="btn-danger" onclick="openGrandResetModal()" style="background: #ff4444; padding: 15px 30px; font-size: 16px;">
          ğŸ”´ Grand Reset - Tout supprimer
        </button>
        <div id="grandResetResult" class="result"></div>
      </div>
      
      <!-- Modal Grand Reset -->
      <div id="grandResetModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; justify-content: center; align-items: center;">
        <div style="background: #1a1a2e; padding: 30px; border-radius: 15px; max-width: 450px; border: 2px solid #ff4444;">
          <h3 style="color: #ff4444; margin-top: 0;">âš ï¸ Confirmation Grand Reset</h3>
          <p style="color: #fff;">Cette action va supprimer :</p>
          <ul style="color: #ccc; font-size: 14px;">
            <li>Tous les utilisateurs</li>
            <li>Tous les avatars gÃ©nÃ©rÃ©s</li>
            <li>Tout l'historique (emails, rewards, workflows)</li>
            <li>Toutes les notifications</li>
            <li>Tous les coupons en attente</li>
          </ul>
          <p style="color: #ff4444; font-weight: bold;">Les IDs recommenceront Ã  1.</p>
          
          <!-- Option Stats -->
          <div style="margin: 15px 0; padding: 15px; background: rgba(0,255,255,0.1); border-radius: 8px; border: 1px solid rgba(0,255,255,0.3);">
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; color: #00ffff;">
              <input type="checkbox" id="grandResetStats" style="width: 20px; height: 20px;">
              <span>ğŸ“Š <strong>Ã‰galement supprimer les STATS de jeu</strong></span>
            </label>
            <p style="color: #888; font-size: 12px; margin: 8px 0 0 30px;">
              Stats des joueurs, badges, classements, snapshots mensuels
            </p>
          </div>
          
          <div style="margin: 20px 0;">
            <label style="color: #fff;">Code secret Admin (celui de l'URL) :</label>
            <input type="password" id="grandResetPassword" placeholder="Code secret admin" 
                   style="width: 100%; padding: 12px; margin-top: 10px; border-radius: 8px; border: 1px solid #444; background: #0a0a15; color: #fff;">
          </div>
          
          <div style="display: flex; gap: 10px;">
            <button onclick="closeGrandResetModal()" style="flex: 1; padding: 12px; background: #444; color: #fff; border: none; border-radius: 8px; cursor: pointer;">
              Annuler
            </button>
            <button onclick="executeGrandReset()" style="flex: 1; padding: 12px; background: #ff4444; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
              ğŸ”´ Confirmer le Reset
            </button>
          </div>
        </div>
      </div>
      
      <!-- Services Externes (Daily.co, Replicate) -->
      <div class="section">
        <h3>ğŸ”Œ Services Externes</h3>
        <button class="btn-primary" onclick="loadExternalServices()">ğŸ”„ Actualiser</button>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 15px;">
          
          <!-- Daily.co -->
          <div id="dailyStatus" style="background: rgba(0,200,255,0.1); border: 1px solid #00c8ff; border-radius: 10px; padding: 20px;">
            <h4 style="color: #00c8ff; margin: 0 0 15px 0;">ğŸ“¹ Daily.co (Visio)</h4>
            <div style="color: #aaa;">Cliquez sur Actualiser...</div>
          </div>
          
          <!-- Replicate -->
          <div id="replicateStatus" style="background: rgba(255,100,200,0.1); border: 1px solid #ff64c8; border-radius: 10px; padding: 20px;">
            <h4 style="color: #ff64c8; margin: 0 0 15px 0;">ğŸ¨ Replicate (Avatars IA)</h4>
            <div style="color: #aaa;">Cliquez sur Actualiser...</div>
          </div>
          
          <!-- Avatars Stats -->
          <div id="avatarStats" style="background: rgba(100,255,100,0.1); border: 1px solid #64ff64; border-radius: 10px; padding: 20px;">
            <h4 style="color: #64ff64; margin: 0 0 15px 0;">ğŸ–¼ï¸ Avatars en base</h4>
            <div style="color: #aaa;">Cliquez sur Actualiser...</div>
          </div>
          
        </div>
      </div>
      
      <!-- Users List -->
      <div class="section">
        <h3>ğŸ“‹ Liste des utilisateurs</h3>
        
        <!-- Compteur de badges -->
        <div id="badgeCounts" style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 20px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 10px;">
          <div style="text-align: center;">
            <img src="/images/badges/platine.png" alt="Platine" style="width: 30px; height: 30px; vertical-align: middle;">
            <span id="countPlatinum" style="font-weight: bold; color: #e5e4e2; margin-left: 5px;">0</span>
            <span style="color: #888; font-size: 0.8em; display: block;">Platine</span>
          </div>
          <div style="text-align: center;">
            <img src="/images/badges/or.png" alt="Or" style="width: 30px; height: 30px; vertical-align: middle;">
            <span id="countGold" style="font-weight: bold; color: #ffd700; margin-left: 5px;">0</span>
            <span style="color: #888; font-size: 0.8em; display: block;">Or</span>
          </div>
          <div style="text-align: center;">
            <img src="/images/badges/argent.png" alt="Argent" style="width: 30px; height: 30px; vertical-align: middle;">
            <span id="countSilver" style="font-weight: bold; color: #c0c0c0; margin-left: 5px;">0</span>
            <span style="color: #888; font-size: 0.8em; display: block;">Argent</span>
          </div>
          <div style="text-align: center;">
            <img src="/images/badges/bronze.png" alt="Bronze" style="width: 30px; height: 30px; vertical-align: middle;">
            <span id="countBronze" style="font-weight: bold; color: #cd7f32; margin-left: 5px;">0</span>
            <span style="color: #888; font-size: 0.8em; display: block;">Bronze</span>
          </div>
          <div style="text-align: center;">
            <img src="/images/badges/fer.png" alt="Fer" style="width: 30px; height: 30px; vertical-align: middle;">
            <span id="countIron" style="font-weight: bold; color: #71797E; margin-left: 5px;">0</span>
            <span style="color: #888; font-size: 0.8em; display: block;">Fer</span>
          </div>
          <div style="text-align: center;">
            <span style="font-size: 1.2em;">â“</span>
            <span id="countNoBadge" style="font-weight: bold; color: #666; margin-left: 5px;">0</span>
            <span style="color: #888; font-size: 0.8em; display: block;">Sans badge</span>
          </div>
        </div>
        
        <button class="btn-primary" onclick="loadUsers()">ğŸ”„ RafraÃ®chir la liste</button>
        <div style="overflow-x: auto;">
          <table class="users-table" id="usersTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>Email</th>
                <th>Pseudo</th>
                <th>Badge</th>
                <th>Type</th>
                <th>VÃ©rifiÃ©</th>
                <th>CrÃ©dits</th>
                <th>Avatars</th>
                <th>Inscrit le</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="usersBody">
              <tr><td colspan="10" style="text-align: center; color: #666;">Clique sur "RafraÃ®chir" pour charger</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      
    </div>
  </div>
  
  <script>
    let adminSecret = '';
    
    function login() {
      adminSecret = document.getElementById('secretInput').value;
      
      if (!adminSecret) {
        showResult('loginResult', 'Code secret requis', false);
        return;
      }
      
      // Test avec l'API stats
      fetch(`/api/admin/stats?secretCode=${encodeURIComponent(adminSecret)}`)
        .then(r => r.json())
        .then(data => {
          if (data.ok) {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            loadStats();
            loadUsers();
            loadExternalServices();
            // V35: Auto-refresh stats serveur toutes les 30 secondes
            if (!window.statsInterval) {
              window.statsInterval = setInterval(loadStats, 30000);
            }
          } else {
            showResult('loginResult', data.error || 'Code invalide', false);
          }
        })
        .catch(err => {
          showResult('loginResult', 'Erreur de connexion', false);
        });
    }
    
    function logout() {
      adminSecret = '';
      document.getElementById('loginScreen').style.display = 'block';
      document.getElementById('adminPanel').style.display = 'none';
      document.getElementById('secretInput').value = '';
    }
    
    function goToStripeAdmin() {
      if (!adminSecret) {
        alert('Vous devez etre connecte pour acceder a l admin Stripe');
        return;
      }
      window.location.href = `admin-stripe.html?secretCode=${encodeURIComponent(adminSecret)}`;
    }
    
    function showResult(elementId, message, success) {
      const el = document.getElementById(elementId);
      el.textContent = message;
      el.className = 'result ' + (success ? 'success' : 'error');
      el.style.display = 'block';
      setTimeout(() => el.style.display = 'none', 5000);
    }
    
    function loadStats() {
      fetch(`/api/admin/stats?secretCode=${encodeURIComponent(adminSecret)}`)
        .then(r => r.json())
        .then(data => {
          if (data.ok) {
            // Stats utilisateurs
            document.getElementById('statTotal').textContent = data.stats.totalUsers;
            document.getElementById('statVerified').textContent = data.stats.verifiedUsers;
            document.getElementById('statSubscribers').textContent = data.stats.subscribers;
            document.getElementById('statPacks').textContent = data.stats.packs;
            document.getElementById('statAdmins').textContent = data.stats.admins;
            
            // V35: Stats serveur
            if (data.server) {
              document.getElementById('statUptime').textContent = data.server.uptime;
              document.getElementById('statMemory').textContent = `${data.server.memory.heapUsed}/${data.server.memory.heapTotal}`;
              document.getElementById('statRooms').textContent = data.server.activeRooms;
              document.getElementById('statPlayers').textContent = `${data.server.playersInGame}/${data.server.totalPlayers}`;
            }
          }
        });
    }
    
    // Cache des badges par username
    let badgesCache = {};
    
    // Charger les badges depuis la nouvelle API
    async function loadBadges() {
      try {
        const res = await fetch('/api/stats/badges');
        const data = await res.json();
        
        if (data.badges && Array.isArray(data.badges)) {
          badgesCache = {};
          data.badges.forEach(e => {
            badgesCache[e.username] = {
              tier: e.tier || null,
              rank: e.rank,
              category: e.category,
              gamesPlayed: e.gamesPlayed
            };
          });
        }
      } catch (err) {
        console.error('Erreur chargement badges:', err);
      }
    }
    
    // Obtenir l'HTML d'un badge
    function getBadgeHtml(username) {
      const badge = badgesCache[username];
      if (!badge || !badge.tier) {
        return '<span style="color:#666;">â€”</span>';
      }
      
      const tierInfo = {
        platinum: { img: 'platine', color: '#e5e4e2', label: 'Platine' },
        gold: { img: 'or', color: '#ffd700', label: 'Or' },
        silver: { img: 'argent', color: '#c0c0c0', label: 'Argent' },
        bronze: { img: 'bronze', color: '#cd7f32', label: 'Bronze' },
        iron: { img: 'fer', color: '#71797E', label: 'Fer' }
      };
      
      const info = tierInfo[badge.tier] || tierInfo.iron;
      const rankText = badge.rank ? `#${badge.rank}` : '';
      return `<img src="/images/badges/${info.img}.png" style="width:20px;height:20px;vertical-align:middle;" title="${info.label}${rankText ? ' ' + rankText : ''}"> <span style="color:${info.color};font-size:0.85em;">${rankText}</span>`;
    }
    
    // Mettre Ã  jour les compteurs de badges
    function updateBadgeCounts(users) {
      const counts = {
        platinum: 0,
        gold: 0,
        silver: 0,
        bronze: 0,
        iron: 0,
        none: 0
      };
      
      users.forEach(u => {
        const badge = badgesCache[u.username];
        if (badge && badge.tier && counts.hasOwnProperty(badge.tier)) {
          counts[badge.tier]++;
        } else {
          counts.none++;
        }
      });
      
      document.getElementById('countPlatinum').textContent = counts.platinum;
      document.getElementById('countGold').textContent = counts.gold;
      document.getElementById('countSilver').textContent = counts.silver;
      document.getElementById('countBronze').textContent = counts.bronze;
      document.getElementById('countIron').textContent = counts.iron;
      document.getElementById('countNoBadge').textContent = counts.none;
    }
    
    async function loadUsers() {
      // D'abord charger les badges
      await loadBadges();
      
      fetch(`/api/admin/users?secretCode=${encodeURIComponent(adminSecret)}`)
        .then(r => r.json())
        .then(data => {
          if (data.ok) {
            const tbody = document.getElementById('usersBody');
            if (data.users.length === 0) {
              tbody.innerHTML = '<tr><td colspan="10" style="text-align: center;">Aucun utilisateur</td></tr>';
              return;
            }
            
            // Mettre Ã  jour les compteurs
            updateBadgeCounts(data.users);
            
            tbody.innerHTML = data.users.map(u => `
              <tr>
                <td>${u.id}</td>
                <td>${u.email}</td>
                <td>${u.username}</td>
                <td>${getBadgeHtml(u.username)}</td>
                <td><span class="badge badge-${u.account_type}">${u.account_type}</span></td>
                <td class="${u.email_verified ? 'verified' : 'not-verified'}">${u.email_verified ? 'âœ…' : 'âŒ'}</td>
                <td>${u.video_credits === 999999 ? 'âˆ' : u.video_credits}</td>
                <td>${u.avatars_remaining === Infinity ? 'âˆ' : `<span style="color: ${u.avatars_remaining === 0 ? '#ff4444' : u.avatars_remaining <= 5 ? '#ffaa00' : '#44ff44'}">${u.avatars_remaining}/${u.avatars_total}</span>`}</td>
                <td>${new Date(u.created_at).toLocaleDateString('fr-FR')}</td>
                <td>
                  <button class="btn-success action-btn" onclick="quickUpgrade('${u.email}', 'subscriber')">Sub</button>
                  <button class="btn-warning action-btn" onclick="giftAvatars('${u.email}')" title="Offrir des avatars">ğŸ</button>
                  <button class="btn-danger action-btn" onclick="quickDelete('${u.email}')">ğŸ—‘ï¸</button>
                </td>
              </tr>
            `).join('');
          }
        });
    }
    
    function loadExternalServices() {
      document.getElementById('dailyStatus').innerHTML = '<h4 style="color: #00c8ff; margin: 0 0 15px 0;">ğŸ“¹ Daily.co (Visio)</h4><div style="color: #aaa;">â³ Chargement...</div>';
      document.getElementById('replicateStatus').innerHTML = '<h4 style="color: #ff64c8; margin: 0 0 15px 0;">ğŸ¨ Replicate (Avatars IA)</h4><div style="color: #aaa;">â³ Chargement...</div>';
      document.getElementById('avatarStats').innerHTML = '<h4 style="color: #64ff64; margin: 0 0 15px 0;">ğŸ–¼ï¸ Avatars en base</h4><div style="color: #aaa;">â³ Chargement...</div>';
      
      fetch(`/api/admin/external-services?secretCode=${encodeURIComponent(adminSecret)}`)
        .then(r => r.json())
        .then(data => {
          // Daily.co
          const daily = data.daily;
          let dailyHtml = '<h4 style="color: #00c8ff; margin: 0 0 15px 0;">ğŸ“¹ Daily.co (Visio)</h4>';
          if (daily.status === 'ok') {
            const usageColor = daily.percentUsed > 80 ? '#ff4444' : daily.percentUsed > 50 ? '#ffaa00' : '#00ff88';
            dailyHtml += `
              <div style="color: #fff; margin-bottom: 5px;"><strong>Domaine:</strong> ${daily.domain}</div>
              
              <div style="margin: 15px 0; padding: 12px; background: rgba(0,0,0,0.4); border-radius: 8px;">
                <div style="color: #aaa; font-size: 12px; margin-bottom: 5px;">Included participant-minutes</div>
                <div style="background: #333; border-radius: 5px; height: 12px; overflow: hidden;">
                  <div style="background: linear-gradient(90deg, #00c8ff, #00ff88); width: ${Math.min(daily.percentUsed, 100)}%; height: 100%; border-radius: 5px; transition: width 0.5s;"></div>
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                  <span style="color: ${usageColor}; font-weight: bold;">${daily.usedMinutes} min used</span>
                  <span style="color: #888;">Max ${daily.maxMinutes.toLocaleString()} min</span>
                </div>
              </div>
              
              <div style="color: #fff;"><strong>Sessions ce mois:</strong> ${daily.totalSessions}</div>
              <div style="color: #fff;"><strong>Rooms:</strong> ${daily.totalRooms} / ${daily.maxRooms.toLocaleString()}</div>
              <div style="color: #888; font-size: 11px; margin-top: 5px;">Reset le 1er du mois</div>
              <a href="${daily.dashboardUrl}" target="_blank" style="display: inline-block; margin-top: 10px; color: #00c8ff; font-size: 12px;">ğŸ“Š Voir dashboard Daily.co â†’</a>
            `;
          } else if (daily.status === 'not_configured') {
            dailyHtml += '<div style="color: #ffaa00;">âš ï¸ Non configurÃ©</div><div style="color: #888; font-size: 12px;">DAILY_API_KEY manquant</div>';
          } else {
            dailyHtml += `<div style="color: #ff4444;">âŒ Erreur: ${daily.error}</div>`;
          }
          document.getElementById('dailyStatus').innerHTML = dailyHtml;
          
          // Replicate
          const replicate = data.replicate;
          let replicateHtml = '<h4 style="color: #ff64c8; margin: 0 0 15px 0;">ğŸ¨ Replicate (Avatars IA)</h4>';
          if (replicate.status === 'ok') {
            replicateHtml += `
              <div style="color: #fff; margin-bottom: 5px;"><strong>Compte:</strong> ${replicate.username}</div>
              
              <div style="margin: 15px 0; padding: 12px; background: rgba(0,0,0,0.4); border-radius: 8px;">
                <div style="color: #aaa; font-size: 12px; margin-bottom: 5px;">Credit remaining</div>
                <div style="color: #00ff88; font-size: 24px; font-weight: bold;">
                  ğŸ’³ Voir sur dashboard
                </div>
                <div style="color: #888; font-size: 11px;">L'API Replicate ne fournit pas le solde</div>
              </div>
              
              <div style="color: #fff;"><strong>Avatars ce mois:</strong> ${replicate.thisMonthPredictions}</div>
              <div style="color: #fff;">âœ… ${replicate.succeeded} rÃ©ussis | âŒ ${replicate.failed} Ã©checs</div>
              <a href="${replicate.dashboardUrl}" target="_blank" style="display: inline-block; margin-top: 10px; color: #ff64c8; font-size: 12px;">ğŸ’³ Voir billing Replicate â†’</a>
            `;
          } else if (replicate.status === 'not_configured') {
            replicateHtml += '<div style="color: #ffaa00;">âš ï¸ Non configurÃ©</div><div style="color: #888; font-size: 12px;">REPLICATE_API_TOKEN manquant</div>';
          } else {
            replicateHtml += `<div style="color: #ff4444;">âŒ Erreur: ${replicate.error}</div>`;
          }
          document.getElementById('replicateStatus').innerHTML = replicateHtml;
          
          // Avatar Stats
          const avatars = data.avatarStats;
          document.getElementById('avatarStats').innerHTML = `
            <h4 style="color: #64ff64; margin: 0 0 15px 0;">ğŸ–¼ï¸ Avatars en base</h4>
            <div style="color: #fff;"><strong>Total:</strong> ${avatars.total}</div>
            <div style="color: #fff;"><strong>Ce mois:</strong> ${avatars.thisMonth}</div>
            <div style="color: #fff;"><strong>URLs Replicate:</strong> ${avatars.replicateUrls}</div>
          `;
        })
        .catch(err => {
          document.getElementById('dailyStatus').innerHTML = '<h4 style="color: #00c8ff;">ğŸ“¹ Daily.co</h4><div style="color: #ff4444;">âŒ Erreur de chargement</div>';
          document.getElementById('replicateStatus').innerHTML = '<h4 style="color: #ff64c8;">ğŸ¨ Replicate</h4><div style="color: #ff4444;">âŒ Erreur de chargement</div>';
          document.getElementById('avatarStats').innerHTML = '<h4 style="color: #64ff64;">ğŸ–¼ï¸ Avatars</h4><div style="color: #ff4444;">âŒ Erreur de chargement</div>';
        });
    }
    
    function upgradeUser() {
      const email = document.getElementById('upgradeEmail').value;
      const tier = document.getElementById('upgradeTier').value;
      
      if (!email) {
        showResult('upgradeResult', 'Email requis', false);
        return;
      }
      
      fetch('/api/admin/upgrade', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, tier, secretCode: adminSecret })
      })
        .then(r => r.json())
        .then(data => {
          showResult('upgradeResult', data.message || data.error, data.ok);
          if (data.ok) {
            loadStats();
            loadUsers();
            document.getElementById('upgradeEmail').value = '';
          }
        });
    }
    
    function addCredits() {
      const email = document.getElementById('creditsEmail').value;
      const credits = document.getElementById('creditsAmount').value;
      
      if (!email || !credits) {
        showResult('creditsResult', 'Email et crÃ©dits requis', false);
        return;
      }
      
      fetch('/api/admin/add-credits', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, credits: parseInt(credits), secretCode: adminSecret })
      })
        .then(r => r.json())
        .then(data => {
          showResult('creditsResult', data.message || data.error, data.ok);
          if (data.ok) {
            loadUsers();
            document.getElementById('creditsEmail').value = '';
          }
        });
    }
    
    function deleteUser() {
      const email = document.getElementById('deleteEmail').value;
      
      if (!email) {
        showResult('deleteResult', 'Email requis', false);
        return;
      }
      
      if (!confirm(`Supprimer dÃ©finitivement ${email} ?`)) return;
      
      fetch('/api/admin/delete-user', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, secretCode: adminSecret })
      })
        .then(r => r.json())
        .then(data => {
          showResult('deleteResult', data.message || data.error, data.ok);
          if (data.ok) {
            loadStats();
            loadUsers();
            document.getElementById('deleteEmail').value = '';
          }
        });
    }
    
    // V35: Reset user avatars/video
    function resetUser() {
      const userId = document.getElementById('resetUserId').value;
      if (!userId) {
        showResult('resetUserResult', 'ID utilisateur requis', false);
        return;
      }
      
      const resetAvatars = document.getElementById('resetAvatarsCheck').checked;
      const resetVideo = document.getElementById('resetVideoCheck').checked;
      const deleteAvatarFiles = document.getElementById('deleteAvatarFilesCheck').checked;
      const removeFromFamily = document.getElementById('removeFromFamilyCheck').checked;
      const downgradeToFree = document.getElementById('downgradeToFreeCheck').checked;
      
      if (!resetAvatars && !resetVideo && !deleteAvatarFiles && !removeFromFamily && !downgradeToFree) {
        showResult('resetUserResult', 'SÃ©lectionne au moins une option', false);
        return;
      }
      
      let confirmMsg = `Reset pour user #${userId} :\n`;
      if (downgradeToFree) confirmMsg += 'âš ï¸ DOWNGRADE EN FREE (reset complet)\n';
      if (removeFromFamily) confirmMsg += 'âš ï¸ Retrait du pack famille\n';
      if (resetAvatars) confirmMsg += '- Compteur avatars Ã  0\n';
      if (resetVideo) confirmMsg += '- CrÃ©dits vidÃ©o rÃ©initialisÃ©s\n';
      if (deleteAvatarFiles) confirmMsg += '- SUPPRESSION des fichiers avatars\n';
      
      if (!confirm(confirmMsg + '\nConfirmer ?')) return;
      
      fetch('/api/admin/reset-user', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          userId: parseInt(userId), 
          resetAvatars, 
          resetVideo, 
          deleteAvatarFiles,
          removeFromFamily,
          downgradeToFree,
          secretCode: adminSecret 
        })
      })
        .then(r => r.json())
        .then(data => {
          showResult('resetUserResult', data.message || data.error, data.ok);
          if (data.ok) loadUsers();
        });
    }

    function clearIpLogs() {
      if (!confirm('Effacer toutes les limites IP ?')) return;
      
      fetch('/api/admin/clear-ip-logs', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ secretCode: adminSecret })
      })
        .then(r => r.json())
        .then(data => {
          showResult('ipResult', data.message || data.error, data.ok);
        });
    }
    
    // ========== GRAND RESET ==========
    function openGrandResetModal() {
      document.getElementById('grandResetModal').style.display = 'flex';
      document.getElementById('grandResetPassword').value = '';
      document.getElementById('grandResetStats').checked = false;
      document.getElementById('grandResetPassword').focus();
    }
    
    function closeGrandResetModal() {
      document.getElementById('grandResetModal').style.display = 'none';
    }
    
    async function executeGrandReset() {
      const password = document.getElementById('grandResetPassword').value;
      const resetStats = document.getElementById('grandResetStats').checked;
      
      if (!password) {
        alert('Veuillez entrer le mot de passe admin');
        return;
      }
      
      // Confirmation supplÃ©mentaire si stats cochÃ©es
      if (resetStats) {
        if (!confirm('âš ï¸ Tu vas Ã©galement supprimer TOUTES les stats de jeu (classements, badges, snapshots). Continuer ?')) {
          return;
        }
      }
      
      const resultDiv = document.getElementById('grandResetResult');
      resultDiv.innerHTML = 'â³ Reset en cours...';
      resultDiv.className = 'result';
      
      try {
        const response = await fetch('/api/admin/grand-reset', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            secretCode: adminSecret,
            adminPassword: password,
            resetStats: resetStats
          })
        });
        
        const data = await response.json();
        
        if (data.ok) {
          closeGrandResetModal();
          showResult('grandResetResult', 'âœ… ' + data.message, true);
          loadUsers(); // RafraÃ®chir la liste (sera vide)
          loadStats(); // RafraÃ®chir les stats
        } else {
          showResult('grandResetResult', 'âŒ ' + (data.error || 'Erreur'), false);
        }
      } catch (error) {
        showResult('grandResetResult', 'âŒ Erreur: ' + error.message, false);
      }
    }
    
    // Fermer modal si clic en dehors
    document.getElementById('grandResetModal')?.addEventListener('click', function(e) {
      if (e.target === this) closeGrandResetModal();
    });
    
    function quickUpgrade(email, tier) {
      if (!confirm(`Passer ${email} en ${tier} ?`)) return;
      
      fetch('/api/admin/upgrade', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, tier, secretCode: adminSecret })
      })
        .then(r => r.json())
        .then(data => {
          if (data.ok) {
            loadStats();
            loadUsers();
          } else {
            alert(data.error);
          }
        });
    }
    
    
    function giftAvatars(email) {
      const amount = prompt('Combien d\'avatars offrir ? (1-100)', '5');
      if (!amount || isNaN(amount) || amount < 1 || amount > 100) {
        alert('Montant invalide (doit Ãªtre entre 1 et 100)');
        return;
      }
      
      const reason = prompt('Raison (optionnel)', 'Cadeau admin');
      
      if (!confirm(`Offrir ${amount} avatars Ã  ${email} ?`)) return;
      
      fetch('/api/admin/gift-avatars', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, amount: parseInt(amount), reason, secretCode: adminSecret })
      })
        .then(r => r.json())
        .then(data => {
          if (data.ok) {
            alert(`âœ… ${amount} avatars offerts Ã  ${email}`);
            loadUsers();
          } else {
            alert('âŒ ' + data.error);
          }
        });
    }
    function quickDelete(email) {
      if (!confirm(`Supprimer dÃ©finitivement ${email} ?`)) return;
      
      fetch('/api/admin/delete-user', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, secretCode: adminSecret })
      })
        .then(r => r.json())
        .then(data => {
          if (data.ok) {
            loadStats();
            loadUsers();
          } else {
            alert(data.error);
          }
        });
    }
  </script>
</body>
</html>
